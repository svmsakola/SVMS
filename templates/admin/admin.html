<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVMS ADMINISTRATION</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        :root {
            --primary-blue: #2c3e90;
            --secondary-blue: #3498db;
            --light-blue: #e6f2ff;
            --white: #ffffff;
            --text-dark: #2c3e50;
            --text-gray: #7f8c8d;
            --border-color: #e0e0e0;
            --table-header-bg: #f2f6fa;
            --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 15px 30px rgba(52, 152, 219, 0.15);
            --placeholder-bg: #e2e8f0;
            --placeholder-text: #64748b;
            --success-green: #2ecc71;
            --warning-orange: #f39c12;
            --error-red: #e74c3c;
            --action-delete-bg: #e74c3c;
            --action-delete-hover-bg: #c0392b;
            --action-delete-user-bg: #9b211b; /* Darker red for user delete */
            --action-delete-user-hover-bg: #781a14;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-blue);
            color: var(--text-dark);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .dashboard-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: linear-gradient(135deg, #e6f2ff 0%, #f8fbff 100%);
        }

        .header {
            background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
            color: var(--white);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .header img {height: 60px; width: auto; max-height: 100%; object-fit: contain;}

        .header-subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .profile-container {
            position: relative;
        }

        .profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-icon:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .profile-icon i {
            font-size: 1.2rem;
        }

        .dropdown-menu {
            position: absolute;
            top: 50px;
            right: 0;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dropdown-item:first-child {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .dropdown-item:last-child {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .dropdown-item:hover {
            background-color: var(--light-blue);
        }

        .dropdown-item i {
            width: 20px;
            text-align: center;
        }

        .divider {
            height: 1px;
            background-color: #e0e0e0;
            margin: 5px 0;
        }

        .user-info {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .user-details h3 {
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .user-details p {
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .main-wrapper {
            display: flex;
            flex: 1;
            margin-top: 70px; /* Adjust based on header height */
        }

        .main-content {
            flex: 1;
            padding: 30px;
            margin-left: 0; /* Removed fixed sidebar margin */
            overflow-y: auto; /* Allow content to scroll if needed */
        }

        /* ---- Visitor Log Styles ---- */
        .visitor-log-container {
            background-color: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 15px;
        }

        .log-header h2 {
            color: var(--primary-blue);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .date-filter {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-filter label {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .date-filter input[type="date"] {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: var(--white);
            color: var(--text-dark);
            cursor: pointer;
        }

        .table-container {
            overflow-x: auto; /* Allow horizontal scrolling for the table */
        }

        .visitor-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .visitor-table th,
        .visitor-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap; /* Prevent text wrapping in cells */
            vertical-align: middle; /* Align content vertically */
        }

        .visitor-table thead th {
            background-color: var(--table-header-bg);
            color: var(--primary-blue);
            font-weight: 600;
            position: sticky;
            top: 0; /* Stick header to top on scroll */
            z-index: 10;
        }

        .visitor-table tbody tr:hover {
            background-color: var(--light-blue);
        }

        .visitor-table td .profile-img-container {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            display: inline-block; /* Aligns better in table cell */
            vertical-align: middle;
            background-color: var(--placeholder-bg);
            text-align: center;
            line-height: 40px;
            font-weight: bold;
            color: var(--placeholder-text);
            font-size: 1rem;
        }

        .visitor-table td .profile-img-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: capitalize;
            color: var(--white);
            display: inline-block;
        }

        .status-new { background-color: var(--secondary-blue); }
        .status-pending { background-color: var(--warning-orange); }
        .status-completed { background-color: var(--success-green); }
        .status-default { background-color: var(--text-gray); }

        .confirmation-icon {
            font-size: 1.1rem;
            vertical-align: middle;
        }
        .confirmation-icon.yes { color: var(--success-green); }
        .confirmation-icon.no { color: var(--error-red); }

        .loading-message, .no-data-message {
            text-align: center;
            padding: 30px;
            color: var(--text-gray);
            font-style: italic;
        }

        /* Styles for File Status and Actions */
        .file-status-icons span {
            display: inline-block;
            margin-right: 8px;
            font-size: 1.1rem;
            cursor: default; /* Indicate they are not clickable */
        }
        .file-status-icons .fa-check-circle { color: var(--success-green); }
        .file-status-icons .fa-times-circle { color: var(--error-red); }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px;
            transition: color 0.2s ease;
            vertical-align: middle; /* Align buttons nicely */
        }
        .view-pdf-btn-table {
             background-color: var(--secondary-blue);
             color: white;
             border: none;
             padding: 5px 10px;
             border-radius: 4px;
             cursor: pointer;
             font-size: 0.8rem;
             transition: background-color 0.2s ease;
             vertical-align: middle;
             display: inline-flex; /* Helps align icon and text */
             align-items: center;
             gap: 4px;
        }
        .view-pdf-btn-table i { line-height: 1; } /* Adjust icon alignment if needed */
        .view-pdf-btn-table:hover { background-color: var(--primary-blue); }
        .view-pdf-btn-table:disabled { background-color: var(--text-gray); cursor: not-allowed; }

        /* Action Column Styles */
        .visitor-table td.actions-cell {
            white-space: nowrap; /* Prevent buttons wrapping */
            text-align: center; /* Center buttons in the cell */
        }
        .delete-visit-btn { color: var(--action-delete-bg); margin-right: 10px; } /* Add margin */
        .delete-visit-btn:hover { color: var(--action-delete-hover-bg); }

        .delete-user-btn { color: var(--action-delete-user-bg); } /* Distinct color */
        .delete-user-btn:hover { color: var(--action-delete-user-hover-bg); }
        /* End Action Column Styles */


        /* --- Modal Styles --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            z-index: 1050; /* Ensure modal is above table header */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }
        .modal.active { display: flex; } /* Use class to show modal */

        .modal-content {
            background-color: var(--white);
            border-radius: 10px;
            padding: 30px;
            width: 400px; /* Slightly wider for confirmation */
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .modal-title {
            font-size: 1.3rem; /* Larger title */
            color: var(--primary-blue);
            margin-bottom: 15px;
            font-weight: 600;
        }
        .modal-content p {
            margin-bottom: 25px;
            color: var(--text-dark);
            line-height: 1.5;
            font-size: 0.95rem;
        }
         .modal-content strong { /* Style for highlighting visitor ID */
             color: var(--primary-blue);
             font-weight: bold;
         }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px; /* Increased gap */
            margin-top: 25px;
        }

        .modal-btn {
            padding: 10px 25px; /* More padding */
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600; /* Bolder */
            transition: all 0.3s ease;
            font-size: 0.9rem;
            border: none;
        }

        .modal-btn-confirm {
            background-color: var(--primary-blue);
            color: white;
        }
        .modal-btn-confirm.delete-visit { background-color: var(--action-delete-bg); } /* Style for visit delete */
        .modal-btn-confirm.delete-user { background-color: var(--action-delete-user-bg); } /* Style for user delete */
        .modal-btn-confirm:hover { background-color: var(--secondary-blue); }
        .modal-btn-confirm.delete-visit:hover { background-color: var(--action-delete-hover-bg); }
        .modal-btn-confirm.delete-user:hover { background-color: var(--action-delete-user-hover-bg); }

        .modal-btn-cancel {
            background-color: #e0e0e0;
            color: var(--text-dark);
        }
        .modal-btn-cancel:hover { background-color: #c7ced4; }

        .modal-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* PDF Viewer Popup Styles */
        .pdf-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1100; /* Higher than other popups */
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .pdf-popup-overlay.active {
            display: flex; /* Show when active */
            opacity: 1;
        }
        .pdf-popup-content {
            position: relative;
            width: 95%;
            height: 95%;
            max-width: 1200px; /* Max width for large screens */
            background-color: #333;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .pdf-close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 24px;
            line-height: 35px;
            text-align: center;
            cursor: pointer;
            z-index: 1101;
            transition: background-color 0.2s ease;
        }
        .pdf-close-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        #pdf-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        /* --- End Modal Styles --- */


        @media (max-width: 768px) {
            .header { padding: 6px 10px; }
            .header img {height: 50px;}
            .header-subtitle { font-size: 0.8rem; }
            .dropdown-menu { right: -10px; min-width: 220px; }
            .main-content { padding: 15px; }
            .main-wrapper { margin-top: 60px; }
            .visitor-log-container { padding: 15px; }
            .log-header { flex-direction: column; align-items: flex-start; }
            .log-header h2 { font-size: 1.3rem; }
            .visitor-table th, .visitor-table td { padding: 10px 12px; font-size: 0.85rem; }
             .view-pdf-btn-table { padding: 4px 8px; font-size: 0.75rem; }
             .action-btn { font-size: 1rem; }
             .file-status-icons span { font-size: 1rem; margin-right: 5px;}
        }

        @media (max-width: 480px) {
            .header img {height: 45px;}
            .header-subtitle { display: none; }
            .main-wrapper { margin-top: 55px; }
            .visitor-table td .profile-img-container { width: 35px; height: 35px; line-height: 35px; font-size: 0.9rem; }
            .status-badge { padding: 3px 8px; font-size: 0.75rem; }
             .view-pdf-btn-table { padding: 3px 6px; font-size: 0.7rem; }
             .file-status-icons span { margin-right: 4px;}
             .delete-visit-btn { margin-right: 5px; } /* Adjust spacing for small screens */
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="header">
            <div class="header-left">
                 <img src="{{ url_for('static', filename='assets/logo/svmslogo.png') }}" alt="Smart Visitor Management System Logo">
                 <div class="header-title" style="margin-left: 15px;">
                     <h1 style="font-size: 1.4rem; margin: 0;">Admin Dashboard</h1>
                     <p class="header-subtitle">Visitor Logs & Management</p>
                 </div>
             </div>
            <div class="profile-container">
                <div class="profile-icon" id="profileIcon">
                    <i class="fas fa-user"></i>
                </div>
                <div class="dropdown-menu" id="dropdownMenu">
                     <div class="user-info">
                         <div class="user-avatar" id="userAvatar">A</div>
                         <div class="user-details">
                             <h3 id="userName">Admin</h3>
                             <p id="userRole">Administrator</p>
                         </div>
                     </div>
                    <div class="divider"></div>
                    <div class="dropdown-item" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="main-wrapper">
            <div class="main-content" id="mainContent">
                <div class="visitor-log-container">
                    <div class="log-header">
                        <h2>Visitor Log</h2>
                        <div class="date-filter">
                            <label for="visitorDate">Select Date:</label>
                            <input type="date" id="visitorDate" name="visitorDate">
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="visitor-table" id="visitorTable">
                            <thead>
                                <tr>
                                    <th>Profile</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Address</th>
                                    <th>Tahasil</th>
                                    <th>District</th>
                                    <th>Visit ID</th>
                                    <th>Date & Time</th>
                                    <th>Purpose</th>
                                    <th>Document</th> <!-- PDF View Button -->
                                    <th>File Status</th> <!-- Check Icons -->
                                    <th>Status</th> <!-- Visit Status Badge -->
                                    <th>Entry Confirmed</th>
                                    <th>Forwarded To</th>
                                    <th>Remark</th>
                                    <th>Action</th> <!-- Delete Buttons -->
                                </tr>
                            </thead>
                            <tbody id="visitorTableBody">
                                <!-- Data will be loaded here by JavaScript -->
                                <tr><td colspan="16" class="loading-message">Loading visitor data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logout Modal -->
        <div class="modal" id="logoutModal">
            <div class="modal-content">
                <h3 class="modal-title">Confirm Logout</h3>
                <p>Are you sure you want to logout?</p>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" id="cancelLogout">Cancel</button>
                    <button class="modal-btn modal-btn-confirm" id="confirmLogout">Logout</button>
                </div>
            </div>
        </div>

        <!-- Delete Specific Visit Confirmation Modal -->
        <div class="modal" id="deleteVisitModal">
            <div class="modal-content">
                <h3 class="modal-title">Delete Visit Entry</h3>
                <p>Are you sure you want to delete the specific visit entry with ID: <strong id="deleteVisitIdDisplay"></strong>?</p>
                <p style="font-size: 0.85rem; color: var(--text-gray);">The user's main profile and other visits will remain.</p>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" id="deleteVisitCancel">Cancel</button>
                    <button class="modal-btn modal-btn-confirm delete-visit" id="deleteVisitConfirm">Delete Visit</button>
                </div>
            </div>
        </div>

        <!-- Delete Entire User Confirmation Modal -->
        <div class="modal" id="deleteUserModal">
            <div class="modal-content">
                <h3 class="modal-title" style="color: var(--error-red);">Delete Entire User</h3>
                <p>Are you sure you want to permanently delete the user <strong id="deleteUserNameDisplay"></strong> (UID: <strong id="deleteUserUidDisplay"></strong>)?</p>
                <p style="font-size: 0.9rem; color: var(--error-red);">This action will remove <strong>ALL</strong> visits and personal data associated with this user and cannot be undone.</p>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" id="deleteUserCancel">Cancel</button>
                    <button class="modal-btn modal-btn-confirm delete-user" id="deleteUserConfirm">Delete User Permanently</button>
                </div>
            </div>
        </div>


        <!-- PDF Viewer Popup -->
        <div id="pdf-popup-overlay" class="pdf-popup-overlay">
            <div class="pdf-popup-content">
                <button id="pdf-close-btn" class="pdf-close-btn">Ã—</button>
                <iframe id="pdf-iframe" src="" frameborder="0"></iframe>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Element References ---
            const profileIcon = document.getElementById('profileIcon');
            const dropdownMenu = document.getElementById('dropdownMenu');
            const logoutBtn = document.getElementById('logoutBtn');
            const logoutModal = document.getElementById('logoutModal');
            const cancelLogout = document.getElementById('cancelLogout');
            const confirmLogout = document.getElementById('confirmLogout');
            const visitorDateInput = document.getElementById('visitorDate');
            const visitorTableBody = document.getElementById('visitorTableBody');
            const userAvatar = document.getElementById('userAvatar');
            const userNameDisplay = document.getElementById('userName');
            const userRoleDisplay = document.getElementById('userRole');

            // Delete Visit Modal Elements
            const deleteVisitModal = document.getElementById('deleteVisitModal');
            const deleteVisitCancelBtn = document.getElementById('deleteVisitCancel');
            const deleteVisitConfirmBtn = document.getElementById('deleteVisitConfirm');
            const deleteVisitIdDisplay = document.getElementById('deleteVisitIdDisplay');

            // Delete User Modal Elements
            const deleteUserModal = document.getElementById('deleteUserModal');
            const deleteUserCancelBtn = document.getElementById('deleteUserCancel');
            const deleteUserConfirmBtn = document.getElementById('deleteUserConfirm');
            const deleteUserUidDisplay = document.getElementById('deleteUserUidDisplay');
            const deleteUserNameDisplay = document.getElementById('deleteUserNameDisplay');

            // PDF Popup Elements
            const pdfPopupOverlay = document.getElementById('pdf-popup-overlay');
            const pdfCloseBtn = document.getElementById('pdf-close-btn');
            const pdfIframe = document.getElementById('pdf-iframe');

            // --- State Variables ---
            let visitToDelete = { uid: null, visit_id: null };
            let userToDelete = { uid: null, name: null };

            // --- User Info and Dropdown Logic ---
            function setUserInfo() {
                 const username = "Admin"; // Replace with actual data if available
                 const role = "Administrator";
                 userNameDisplay.textContent = username;
                 userRoleDisplay.textContent = role;
                 userAvatar.textContent = username.charAt(0).toUpperCase();
             }
             setUserInfo();

            profileIcon.addEventListener('click', () => dropdownMenu.classList.toggle('active'));
            document.addEventListener('click', (event) => {
                if (!profileIcon.contains(event.target) && !dropdownMenu.contains(event.target)) {
                    dropdownMenu.classList.remove('active');
                }
            });
            logoutBtn.addEventListener('click', () => { logoutModal.style.display = 'flex'; dropdownMenu.classList.remove('active'); });
            cancelLogout.addEventListener('click', () => logoutModal.style.display = 'none');
            confirmLogout.addEventListener('click', () => {
                fetch("/logout").then(() => {
                    localStorage.removeItem("user"); window.location.href = "/";
                }).catch(error => {
                    console.error('Logout failed:', error);
                    alert('Logout failed. Please try again.');
                    logoutModal.style.display = 'none';
                });
            });
            // Close modals on outside click
             window.addEventListener('click', (event) => {
                 if (event.target === logoutModal) logoutModal.style.display = 'none';
                 if (event.target === deleteVisitModal) deleteVisitModal.classList.remove('active');
                 if (event.target === deleteUserModal) deleteUserModal.classList.remove('active');
                 if (event.target === pdfPopupOverlay) hidePdfPopup();
             });

            // --- PDF Popup Logic ---
             function showPdfPopup(pdfUrl) {
                 if (pdfUrl && pdfPopupOverlay && pdfIframe) {
                     pdfIframe.src = pdfUrl;
                     pdfPopupOverlay.classList.add('active');
                 } else {
                     console.error("PDF URL or popup elements missing.");
                     alert("Could not load document viewer.");
                 }
             }
             function hidePdfPopup() {
                 if (pdfPopupOverlay && pdfIframe) {
                     pdfPopupOverlay.classList.remove('active');
                     pdfIframe.src = ''; // Clear src to stop loading
                 }
             }
             pdfCloseBtn.addEventListener('click', hidePdfPopup);

             // --- Delete Modals Logic ---
             function showDeleteVisitPopup(uid, visitId) {
                 visitToDelete = { uid, visit_id: visitId };
                 userToDelete = { uid: null, name: null };
                 deleteVisitIdDisplay.textContent = visitId || 'N/A';
                 deleteVisitModal.classList.add('active');
                 deleteVisitConfirmBtn.disabled = false;
                 deleteVisitConfirmBtn.textContent = 'Delete Visit';
             }

             function showDeleteUserPopup(uid, name) {
                 userToDelete = { uid, name };
                 visitToDelete = { uid: null, visit_id: null };
                 deleteUserUidDisplay.textContent = uid || 'N/A';
                 deleteUserNameDisplay.textContent = name || 'N/A';
                 deleteUserModal.classList.add('active');
                 deleteUserConfirmBtn.disabled = false;
                 deleteUserConfirmBtn.textContent = 'Delete User Permanently';
             }

             deleteVisitCancelBtn.addEventListener('click', () => deleteVisitModal.classList.remove('active'));
             deleteUserCancelBtn.addEventListener('click', () => deleteUserModal.classList.remove('active'));
             deleteVisitConfirmBtn.addEventListener('click', executeDeleteVisit);
             deleteUserConfirmBtn.addEventListener('click', executeDeleteUser);

            async function executeDeleteVisit() {
                if (!visitToDelete.uid || !visitToDelete.visit_id) return;
                deleteVisitConfirmBtn.disabled = true;
                deleteVisitConfirmBtn.textContent = 'Deleting...';
                try {
                    const response = await fetch('/api/admin/delete_visitor_entry', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(visitToDelete)
                    });
                    const data = await response.json();
                    if (!response.ok || !data.success) throw new Error(data.message || 'Failed to delete visit entry.');
                    alert('Visitor entry deleted successfully.');
                    deleteVisitModal.classList.remove('active');
                    fetchVisitorData(visitorDateInput.value); // Refresh
                } catch (error) {
                    console.error("Error deleting visit entry:", error); alert(`Error: ${error.message}`);
                    deleteVisitConfirmBtn.disabled = false; deleteVisitConfirmBtn.textContent = 'Delete Visit';
                } finally { visitToDelete = { uid: null, visit_id: null }; }
            }

            async function executeDeleteUser() {
                if (!userToDelete.uid) return;
                deleteUserConfirmBtn.disabled = true;
                deleteUserConfirmBtn.textContent = 'Deleting User...';
                try {
                    const response = await fetch('/api/admin/delete_user', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ uid: userToDelete.uid })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || `Failed to delete user (Status: ${response.status})`);
                    if (!data.success) throw new Error(data.message || 'API reported failure in deleting user.');
                    alert('User and all associated data deleted successfully.');
                    deleteUserModal.classList.remove('active');
                    fetchVisitorData(visitorDateInput.value); // Refresh
                } catch (error) {
                    console.error("Error deleting user:", error); alert(`Error: ${error.message}`);
                    deleteUserConfirmBtn.disabled = false; deleteUserConfirmBtn.textContent = 'Delete User Permanently';
                } finally { userToDelete = { uid: null, name: null }; }
            }


            // --- Visitor Log Logic ---
            function formatDate(date) {
                 const year = date.getFullYear();
                 const month = String(date.getMonth() + 1).padStart(2, '0');
                 const day = String(date.getDate()).padStart(2, '0');
                 return `${year}-${month}-${day}`;
            }

             function formatDateTimeForDisplay(dateTimeString) {
                 if (!dateTimeString) return 'N/A';
                 try {
                     const date = new Date(dateTimeString);
                     return date.toLocaleString('en-IN', {
                         day: '2-digit', month: '2-digit', year: 'numeric',
                         hour: '2-digit', minute: '2-digit', hour12: true
                     });
                 } catch (e) { console.error("Error formatting date:", e); return dateTimeString; }
             }

             function getProfileImageHtml(visitorData) {
                 let imageUrl = visitorData?.profile_img?.[0] || visitorData?.images?.[0] || null;
                 const initials = (visitorData?.name?.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() || '?');
                 const altText = visitorData?.name || 'Visitor';
                 const timestamp = Date.now();
                 // IMPORTANT: Adjust the base path if profile images are served differently
                 const finalImageUrl = imageUrl ? `/dashboard/${imageUrl}?t=${timestamp}` : null;

                 return `<div class="profile-img-container">
                            ${finalImageUrl
                                ? `<img src="${finalImageUrl}" alt="${altText}" onerror="this.style.display='none'; this.parentElement.innerHTML='${initials}';">`
                                : initials
                            }
                         </div>`;
             }

             function getStatusBadge(status) {
                 let badgeClass = 'status-default';
                 let statusText = status || 'unknown';
                 switch (status?.toLowerCase()) {
                     case 'new': badgeClass = 'status-new'; break;
                     case 'pending': badgeClass = 'status-pending'; break;
                     case 'completed': badgeClass = 'status-completed'; break;
                 }
                 return `<span class="status-badge ${badgeClass}">${statusText}</span>`;
            }

             function getConfirmationIcon(confirmed) {
                 const iconClass = confirmed ? 'fas fa-check-circle yes' : 'fas fa-times-circle no';
                 return `<i class="confirmation-icon ${iconClass}"></i>`;
             }

             function renderFileStatusIcons(visitorData) {
                 let iconsHtml = '';
                 const checkIcon = '<span title="Available"><i class="fas fa-check-circle"></i></span>';
                 const crossIcon = '<span title="Missing"><i class="fas fa-times-circle"></i></span>';
                 // Check profile image (check if array exists and has content)
                 iconsHtml += (visitorData?.profile_img && visitorData.profile_img.length > 0) ? checkIcon : crossIcon;
                 // Check other images
                 iconsHtml += (visitorData?.images && visitorData.images.length > 0) ? checkIcon : crossIcon;
                 // Check face encodings
                 iconsHtml += (visitorData?.face_encodings && visitorData.face_encodings.length > 0) ? checkIcon : crossIcon;
                 return `<div class="file-status-icons">${iconsHtml}</div>`;
             }

             async function fetchVisitorData(selectedDate) {
                 visitorTableBody.innerHTML = `<tr><td colspan="16" class="loading-message">Fetching data for ${selectedDate}...</td></tr>`;
                 try {
                     const response = await fetch(`/api/admin/visitors?date=${selectedDate}`);
                     if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                     const data = await response.json();
                     renderVisitorTable(data.visitors || []);
                 } catch (error) {
                     console.error("Error fetching visitor data:", error);
                     visitorTableBody.innerHTML = `<tr><td colspan="16" class="no-data-message">Error loading data: ${error.message}</td></tr>`;
                 }
             }

             function renderVisitorTable(visitors) {
                 if (!visitors || visitors.length === 0) {
                     visitorTableBody.innerHTML = `<tr><td colspan="16" class="no-data-message">No visitors found for the selected date.</td></tr>`;
                     return;
                 }
                 let tableHtml = '';
                 visitors.forEach(visit => {
                     let pdfButton = '-';
                     if (visit.document_pdf) {
                         const pdfUrl = `/api/get-visitor-document/${visit.visit_id}`;
                         pdfButton = `<button class="action-btn view-pdf-btn-table" data-pdf-url="${pdfUrl}" title="View Document"><i class="fas fa-file-pdf"></i></button>`;
                     }

                     tableHtml += `
                         <tr>
                             <td>${getProfileImageHtml(visit)}</td>
                             <td>${visit.name || 'N/A'}</td>
                             <td>${visit.phone || 'N/A'}</td>
                             <td>${visit.address || 'N/A'}</td>
                             <td>${visit.tahasil || 'N/A'}</td>
                             <td>${visit.district || 'N/A'}</td>
                             <td>${visit.visit_id || 'N/A'}</td>
                             <td>${formatDateTimeForDisplay(visit.datetime)}</td>
                             <td>${visit.purpose || 'N/A'}</td>
                             <td>${pdfButton}</td>
                             <td>${renderFileStatusIcons(visit)}</td>
                             <td>${getStatusBadge(visit.status)}</td>
                             <td>${getConfirmationIcon(visit.entry_confirmed)}</td>
                             <td>${visit.forwarding_department || '-'}</td>
                             <td>${visit.forwarding_note || '-'}</td>
                             <td class="actions-cell">
                                 <button class="action-btn delete-visit-btn" data-uid="${visit.uid}" data-visit-id="${visit.visit_id}" title="Delete This Visit Entry">
                                     <i class="fas fa-calendar-times"></i>
                                 </button>
                                 <button class="action-btn delete-user-btn" data-uid="${visit.uid}" data-name="${visit.name || 'N/A'}" title="Delete Entire User & All Visits">
                                     <i class="fas fa-user-times"></i>
                                 </button>
                             </td>
                         </tr>
                     `;
                 });
                 visitorTableBody.innerHTML = tableHtml;
             }

            // --- Event Delegation for Table Buttons ---
            visitorTableBody.addEventListener('click', function(event) {
                const targetButton = event.target.closest('button.action-btn'); // Target only action buttons

                if (!targetButton) return; // Exit if click wasn't on an action button or its icon

                if (targetButton.classList.contains('view-pdf-btn-table')) {
                    const pdfUrl = targetButton.dataset.pdfUrl;
                    showPdfPopup(pdfUrl);
                } else if (targetButton.classList.contains('delete-visit-btn')) {
                    const uid = targetButton.dataset.uid;
                    const visitId = targetButton.dataset.visitId;
                    showDeleteVisitPopup(uid, visitId);
                } else if (targetButton.classList.contains('delete-user-btn')) {
                    const uid = targetButton.dataset.uid;
                    const name = targetButton.dataset.name;
                    showDeleteUserPopup(uid, name);
                }
            });

            // --- Initialization ---
            const todayStr = formatDate(new Date());
            visitorDateInput.value = todayStr;
            fetchVisitorData(todayStr); // Fetch data for today on load
            visitorDateInput.addEventListener('change', function() {
                fetchVisitorData(this.value); // Fetch data when date changes
            });

        });
    </script>
</body>
</html>