<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>एसव्हीएमएस नोंदणी</title>
    <style>
        :root {
            --primary-blue: #2c3e90;
            --secondary-blue: #3498db;
            --light-blue: #e6f2ff;
            --white: #ffffff;
            --text-dark: #2c3e50;
            --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 15px 30px rgba(52, 152, 219, 0.15);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--light-blue) 0%, #f8fbff 100%);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
            color: var(--white);
            padding: 10px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
            height: 60px;
        }

        .header h1 {
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-size: 1.6rem;
            margin: 0;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .profile-container {
            position: relative;
        }

        .profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--white);
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        .profile-icon:hover {
            transform: scale(1.1);
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 50px;
            background-color: var(--white);
            color: var(--text-dark);
            min-width: 150px;
            box-shadow: var(--card-shadow);
            border-radius: 8px;
            z-index: 101;
            overflow: hidden;
        }

        .profile-dropdown.active {
            display: block;
        }

        .profile-dropdown ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .profile-dropdown li {
            padding: 12px 18px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
        }
         .profile-dropdown li:hover {
             background-color: var(--light-blue);
         }
         .profile-dropdown li[disabled] {
             cursor: not-allowed;
             opacity: 0.7;
             background-color: #eee;
         }

        .main {
            display: flex;
            flex: 1;
            overflow-y: auto;
            padding-top: 15px;
        }

        .content {
            flex: 1;
            padding: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            justify-content: center;
        }

        .webcam-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--white);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            align-self: flex-start;
            margin-bottom: 20px;
        }

        .webcam-container:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .registration-form, .existing-visitor-form {
            flex: 1;
            min-width: 300px;
            max-width: 450px;
            padding: 25px;
            background-color: var(--white);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            align-self: flex-start;
        }

        .registration-form:hover, .existing-visitor-form:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .registration-form::after, .existing-visitor-form::after, .webcam-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .registration-form:hover::after, .existing-visitor-form:hover::after, .webcam-container:hover::after {
            transform: scaleX(1);
        }

        video {
            width: 100%;
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border: 1px solid var(--secondary-blue);
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }


        #tahasil {
             color: var(--text-dark);
             background-color: var(--white);
         }

        button {
            background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
            color: var(--white);
            border: none;
            padding: 14px 28px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0) 100%);
            transition: left 0.7s ease;
        }

        button:hover::before {
            left: 100%;
        }

        button:disabled {
             cursor: not-allowed;
             opacity: 0.7;
             background: linear-gradient(to right, #a9b4d4, #a0c4e0);
             box-shadow: none;
             transform: none;
         }
         button:disabled::before {
              display: none;
          }

        .captured-images {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            width: 100%;
        }

        .captured-images img {
            width: 100%;
            max-width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
        }

        .visitor-details {
            background: var(--light-blue);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-blue);
        }

        .last-visit-details {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid var(--secondary-blue);
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.85em;
            margin-top: -5px;
            margin-bottom: 10px;
        }

        .registration-form h2, .existing-visitor-form h2 {
            color: var(--primary-blue);
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.5rem;
        }

        .visitor-profile-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .profile-image-container {
            margin-right: 20px;
            flex-shrink: 0;
            margin-bottom: 10px;
        }

        .profile-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--secondary-blue);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .profile-placeholder {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
        }

        .visitor-info-container {
            flex-grow: 1;
        }

        .visitor-info-container p {
            margin: 5px 0;
        }

         .visitor-info-container p strong {
             margin-right: 5px;
         }
         .last-visit-details p strong {
            margin-right: 5px;
         }


        @media (max-width: 992px) {
             .content {
                 flex-direction: column;
                 align-items: center;
             }
             .webcam-container,
             .registration-form,
             .existing-visitor-form {
                 max-width: 500px;
                 width: 100%;
                 align-self: center;
             }
        }


        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
                height: auto;
                flex-wrap: wrap;
                justify-content: space-around;
            }

             .header h1 {
                 font-size: 1.3rem;
                 width: 100%;
                 text-align: center;
                 margin-bottom: 10px;
            }

            .header-controls {
                 width: 100%;
                 justify-content: flex-end;
             }

            .profile-icon {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }

            .profile-dropdown {
                top: 45px;
            }

            .content {
                padding: 15px;
                gap: 20px;
            }


            .visitor-profile-container {
                flex-direction: column;
                text-align: center;
            }

            .profile-image-container {
                margin-right: 0;
                margin-bottom: 15px;
            }
        }
         @media (max-width: 480px) {
             .header h1 {
                font-size: 1.1rem;
                letter-spacing: 1px;
            }
             .registration-form h2, .existing-visitor-form h2 {
                font-size: 1.3rem;
            }
            button {
                padding: 12px 24px;
                font-size: 0.9rem;
            }
            input, select, textarea {
                padding: 12px;
                font-size: 0.95rem;
            }
         }
    </style>
</head>
<body>
    <div class="header">
        <h1>एस व्ही एम एस नोंदणी</h1>
        <div class="header-controls">
            <div class="profile-container">
                <div class="profile-icon" id="profile-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-person-fill" viewBox="0 0 16 16">
                        <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                      </svg>
                </div>
                <div class="profile-dropdown" id="profile-dropdown">
                    <ul>
                        <li id="logout-button">लॉगआऊट</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="main">
        <div class="content">
            <div class="webcam-container">
                <video id="webcam" autoplay></video>
                <div id="recognition-actions">
                    <button id="start-recognition" onclick="startFaceRecognition(this)">चेहरा ओळखणे सुरू करा</button>
                </div>
                <p id="recognition-result"></p>
                <div id="captured-images" class="captured-images"></div>
            </div>

            <div class="existing-visitor-form" id="existing-visitor-form" style="display:none;">
                <h2>विद्यमान अभ्यागत</h2>
                <div id="existing-visitor-details" class="visitor-details">

                </div>
                <div id="last-visit-section" class="last-visit-details">
                    <h3>शेवटची भेट</h3>
                    <p id="last-visit-info">
                        <span>मागील भेटी नाहीत</span>
                    </p>
                </div>
                <h3>सध्याच्या भेटीचा तपशील</h3>
                <input type="text" id="new-purpose" placeholder="सध्याच्या भेटीचे कारण" required>
                <button onclick="addNewVisitForExistingVisitor(this)">नवीन भेट जोडा</button>
                <button onclick="continueExistingVisit(this)">मागील भेट सुरू ठेवा</button>
            </div>

            <div class="registration-form" id="registration-form" style="display:none;">
                <h2>अभ्यागत नोंदणी</h2>
                <input type="text" id="name" placeholder="पूर्ण नाव" required>
                <input type="tel" id="phone" placeholder="फोन नंबर" required>
                <div id="phone-error" class="error-message"></div>
                <input type="email" id="email" placeholder="ईमेल (पर्यायी)">
                <textarea id="address" placeholder="पत्ता (आवश्यक)" required></textarea>
                <select id="tahasil" required>
                    <option value="" disabled selected>तहसील निवडा</option>
                    <option value="AKOLA">अकोला</option>
                    <option value="AKOT">अकोट</option>
                    <option value="TELAHARA">तेल्हारा</option>
                    <option value="BALAPUR">बाळापूर</option>
                    <option value="PATUR">पातूर</option>
                    <option value="MURTIZAPUR">मुर्तिजापूर</option>
                    <option value="BARSHITAKLI">बार्शीटाकळी</option>
                </select>
                <input type="text" id="purpose" placeholder="भेटीचे कारण" required>
                <button onclick="saveVisitorData(this)">अभ्यागताचा डेटा जतन करा</button>
            </div>
        </div>
    </div>

    <script>
        const domElements = {};
        const requiredFields = [
            { id: 'name', label: 'पूर्ण नाव' },
            { id: 'phone', label: 'फोन नंबर' },
            { id: 'address', label: 'पत्ता' },
            { id: 'tahasil', label: 'तहसील' },
            { id: 'purpose', label: 'भेटीचे कारण' }
        ];

        let capturedFrames = [];
        let currentVisitorData = null;
        let recognizedVisitorData = null;
        let webcamStream = null;

        function showLoading(button, loadingText = "लोड करत आहे...") {
            if (!button) return;
            button.dataset.originalText = button.innerHTML;
            button.innerHTML = loadingText;
            button.disabled = true;
            if (button.tagName === 'LI') {
                 button.style.cursor = 'not-allowed';
                 button.style.opacity = '0.7';
             }
        }

        function hideLoading(button) {
            if (!button || typeof button.dataset?.originalText === 'undefined') return;
             button.innerHTML = button.dataset.originalText;
             button.disabled = false;
             if (button.tagName === 'LI') {
                  button.style.cursor = 'pointer';
                  button.style.opacity = '1';
              }
             delete button.dataset.originalText;
        }

        document.addEventListener('DOMContentLoaded', () => {
            ['webcam', 'recognition-result', 'captured-images', 'registration-form',
             'existing-visitor-form', 'name', 'phone', 'email',
             'address', 'purpose', 'new-purpose', 'phone-error', 'existing-visitor-details',
             'last-visit-info', 'profile-icon', 'profile-dropdown', 'logout-button', 'tahasil'
            ].forEach(id => {
                domElements[id] = document.getElementById(id);
            });

            domElements['profile-icon'].addEventListener('click', (event) => {
                event.stopPropagation();
                domElements['profile-dropdown'].classList.toggle('active');
            });

            document.addEventListener('click', (event) => {
                 if (!domElements['profile-container']?.contains(event.target)) {
                    domElements['profile-dropdown']?.classList.remove('active');
                }
            });

            domElements['logout-button'].addEventListener('click', (event) => confirmLogout(event.currentTarget));

            startWebcam();
        });

        async function startWebcam() {
            try {
                if (webcamStream) {
                    const tracks = webcamStream.getTracks();
                    tracks.forEach(track => track.stop());
                }

                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: "user"
                    }
                };

                webcamStream = await navigator.mediaDevices.getUserMedia(constraints);
                domElements['webcam'].srcObject = webcamStream;

                domElements['webcam'].onloadedmetadata = () => {
                    domElements['webcam'].play();
                };
            } catch (error) {
                console.error("Error accessing webcam:", error);
                const errorMsg = document.createElement('p');
                errorMsg.textContent = 'कॅमेरामध्ये प्रवेश करू शकलो नाही. कृपया परवानग्या तपासा.';
                errorMsg.style.color = "red";
                if (domElements['webcam'] && domElements['webcam'].parentNode) {
                     domElements['webcam'].parentNode.appendChild(errorMsg);
                }
            }
        }

        async function validatePhoneNumber(phone) {
             const phoneRegex = /^[6-9]\d{9}$/;
             const isValid = phoneRegex.test(phone);
             const errorMsg = isValid ? "" : "कृपया योग्य १० अंकी फोन नंबर प्रविष्ट करा जो ६-९ ने सुरू होतो";
             domElements['phone-error'].textContent = errorMsg;
             return isValid;
         }

         function formatLastVisit(visitorData) {
              if (!visitorData || !visitorData.visitor || visitorData.visitor.length === 0) {
                   return `<span>मागील भेटी नाहीत</span>`;
               }

              const lastVisit = visitorData.visitor.reduce((latest, current) =>
                  (new Date(current.datetime) > new Date(latest.datetime)) ? current : latest
              );

              const visitDate = new Date(lastVisit.datetime);
              const formattedDate = visitDate.toLocaleString('mr-IN', { dateStyle: 'short', timeStyle: 'short' })
                                      || `${visitDate.toLocaleDateString()} ${visitDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;

              const dateLabel = "शेवटची भेट तारीख:";
              const purposeLabel = "शेवटच्या भेटीचे कारण:";

              return `
                  <strong>${dateLabel}</strong> ${formattedDate}<br>
                  <strong>${purposeLabel}</strong> ${lastVisit.purpose || 'N/A'}
              `;
          }

        function resetRecognitionData() {
            capturedFrames = [];
            currentVisitorData = null;
            recognizedVisitorData = null;

            if(domElements['recognition-result']) domElements['recognition-result'].textContent = "";
            if(domElements['captured-images']) domElements['captured-images'].innerHTML = "";

            if(domElements['registration-form']) domElements['registration-form'].style.display = "none";
            if(domElements['existing-visitor-form']) {
                 domElements['existing-visitor-form'].style.display = "none";
                  if(domElements['existing-visitor-details']) domElements['existing-visitor-details'].innerHTML = '';
                  if(domElements['last-visit-info']) {
                      domElements['last-visit-info'].innerHTML = `<span>मागील भेटी नाहीत</span>`;
                  }
            }

            ['name', 'phone', 'email', 'address', 'purpose', 'new-purpose'].forEach(id => {
                if (domElements[id]) domElements[id].value = "";
            });
             if(domElements['tahasil']) domElements['tahasil'].selectedIndex = 0;

            if(domElements['phone-error']) domElements['phone-error'].textContent = "";
        }

        async function startFaceRecognition(button) {
             resetRecognitionData();
             showLoading(button, "ओळखत आहे...");

             const video = domElements['webcam'];
             if (!video || !video.videoWidth || !video.videoHeight) {
                  console.error("Webcam not ready or dimensions are zero.");
                  const errorText = "वेबकॅम तयार नाही. कृपया प्रतीक्षा करा आणि पुन्हा प्रयत्न करा.";
                  if(domElements['recognition-result']) domElements['recognition-result'].textContent = errorText;
                  hideLoading(button);
                  return;
             }

             if (!window.recognitionCanvas) {
                  window.recognitionCanvas = document.createElement("canvas");
             }
             const canvas = window.recognitionCanvas;
             canvas.width = video.videoWidth;
             canvas.height = video.videoHeight;
             const ctx = canvas.getContext("2d");
             ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

             canvas.toBlob(async (blob) => {
                  if (!blob) {
                      console.error("Canvas to Blob conversion failed.");
                      const errorText = "प्रतिमा कॅप्चर करण्यात त्रुटी. कृपया पुन्हा प्रयत्न करा.";
                      if(domElements['recognition-result']) domElements['recognition-result'].textContent = errorText;
                      hideLoading(button);
                      return;
                  }
                  const formData = new FormData();
                  formData.append("frame", blob, "frame.jpg");
                  try {
                      const response = await fetch("/detect_face", {
                          method: "POST",
                          body: formData
                      });

                      if (!response.ok) {
                            try {
                                const errData = await response.json();
                                throw new Error(errData.message || `Server error: ${response.status}`);
                            } catch {
                                throw new Error(`Server error: ${response.status}`);
                            }
                      }

                      const result = await response.json();

                      if (result.recognized) {
                           const recognizedPrefix = "ओळखले: ";
                           if(domElements['recognition-result']) domElements['recognition-result'].textContent = `${recognizedPrefix}${result.user_data.name}`;
                           recognizedVisitorData = result.user_data;
                           displayExistingVisitorDetails(result.user_data);
                       } else {
                           const notRecognizedText = "चेहरा ओळखला नाही. नोंदणीसह पुढे जा.";
                           if(domElements['recognition-result']) domElements['recognition-result'].textContent = notRecognizedText;
                           showRegistrationForm(canvas.toDataURL('image/jpeg', 0.8));
                       }
                  } catch (error) {
                      console.error("Recognition error:", error);
                       const errorPrefix = "ओळखण्यात त्रुटी. कृपया पुन्हा प्रयत्न करा.";
                       if(domElements['recognition-result']) domElements['recognition-result'].textContent = `${errorPrefix}${error.message}`;
                  } finally {
                     hideLoading(button);
                  }
              }, "image/jpeg", 0.8);
          }

         function displayExistingVisitorDetails(visitorData) {
             currentVisitorData = visitorData;
             if(domElements['registration-form']) domElements['registration-form'].style.display = "none";
             if(domElements['existing-visitor-form']) domElements['existing-visitor-form'].style.display = "block";

             let profileImgHtml = '';
             if (visitorData.profile_img && visitorData.profile_img.length > 0) {
                 profileImgHtml = `<img src="${visitorData.profile_img[0]}?t=${Date.now()}" alt="${visitorData.name}" class="profile-circle">`;
             } else if (visitorData.images && visitorData.images.length > 0) {
                 profileImgHtml = `<img src="${visitorData.images[0]}?t=${Date.now()}" alt="${visitorData.name}" class="profile-circle">`;
             } else {
                 profileImgHtml = `<div class="profile-circle profile-placeholder">${visitorData.name ? visitorData.name.charAt(0).toUpperCase() : '?'}</div>`;
             }

             const nameLabel = "नाव:";
             const phoneLabel = "फोन:";
             const addressLabel = "पत्ता:";
             const tahasilLabel = "तहसील:";

             if(domElements['existing-visitor-details']) {
                 domElements['existing-visitor-details'].innerHTML = `
                     <div class="visitor-profile-container">
                         <div class="profile-image-container">
                             ${profileImgHtml}
                         </div>
                         <div class="visitor-info-container">
                             <p><strong>${nameLabel}</strong> ${visitorData.name || 'N/A'}</p>
                             <p><strong>${phoneLabel}</strong> ${visitorData.phone || 'N/A'}</p>
                             <p><strong>${addressLabel}</strong> ${visitorData.address || 'N/A'}</p>
                             <p><strong>${tahasilLabel}</strong> ${visitorData.tahasil || 'N/A'}</p>
                         </div>
                     </div>
                 `;
             }

             const lastVisitFormatted = formatLastVisit(visitorData);
             if(domElements['last-visit-info']) domElements['last-visit-info'].innerHTML = lastVisitFormatted;
         }

        function showRegistrationForm(capturedFrame) {
            if(domElements['existing-visitor-form']) domElements['existing-visitor-form'].style.display = "none";
            if(domElements['registration-form']) domElements['registration-form'].style.display = "block";

            const capturedImagesDiv = domElements['captured-images'];
            if (capturedImagesDiv) {
                capturedImagesDiv.innerHTML = '';
                const img = document.createElement("img");
                img.src = capturedFrame;
                capturedImagesDiv.appendChild(img);
            }

            capturedFrames = [capturedFrame];
             currentVisitorData = null;
             recognizedVisitorData = null;
        }

       async function saveVisitorData(button) {
             let isValidForm = true;
             for (let field of requiredFields) {
                 const element = domElements[field.id];
                 if (!element) continue;
                 const value = element.value.trim();

                 if (!value || (field.id === 'tahasil' && element.selectedIndex === 0)) {
                      const alertMsgTemplate = "कृपया {fieldName} फील्ड भरा";
                      alert(alertMsgTemplate.replace('{fieldName}', field.label));
                      element.focus();
                      isValidForm = false;
                      break;
                  }

                 if (field.id === 'phone') {
                      if (!await validatePhoneNumber(value)) {
                          element.focus();
                          isValidForm = false;
                          break;
                      }
                  }
             }

             if (!isValidForm) return;

             if (!capturedFrames || capturedFrames.length === 0 || !capturedFrames[0]) {
                  const alertMsg = "कृपया नोंदणी करण्यापूर्वी एक प्रतिमा कॅप्चर करा";
                  alert(alertMsg);
                  return;
              }

             const visitorData = {
                 name: domElements['name']?.value.trim() ?? '',
                 phone: domElements['phone']?.value.trim() ?? '',
                 email: domElements['email']?.value.trim() || null,
                 address: domElements['address']?.value.trim() ?? '',
                 tahasil: domElements['tahasil']?.value ?? '',
                 purpose: domElements['purpose']?.value.trim() ?? '',
                 frame: capturedFrames[0]
             };

             const confirmMsg = "तुम्हाला खात्री आहे की हा अभ्यागत डेटा जतन करायचा आहे?";
             if (confirm(confirmMsg)) {
                 showLoading(button, "जतन करत आहे...");
                 try {
                     await registerVisitor(visitorData);
                 } catch (error) {
                    console.error("Error during saveVisitorData registration:", error);
                 } finally {
                     hideLoading(button);
                 }
             } else {
                 const cancelMsg = "वापरकर्त्याने अभ्यागत डेटा जतन करणे रद्द केले.";
                 console.log(cancelMsg);
             }
         }


        async function addNewVisitForExistingVisitor(button) {
            const newPurpose = domElements['new-purpose']?.value.trim();
            if (!newPurpose) {
                 const alertMsg = "कृपया सध्याच्या भेटीचे कारण प्रविष्ट करा";
                 alert(alertMsg);
                 domElements['new-purpose']?.focus();
                 return;
             }
            if (!currentVisitorData) {
                 const alertMsg = "अभ्यागत डेटा आढळला नाही. कृपया आधी अभ्यागताला ओळखा.";
                 alert(alertMsg);
                 return;
             }

            const confirmMsg = "तुम्हाला खात्री आहे की या विद्यमान अभ्यागतासाठी नवीन भेट जोडायची आहे?";
             if (confirm(confirmMsg)) {
                 showLoading(button, "भेट जोडत आहे...");
                 const newVisitorData = {
                    ...currentVisitorData,
                    purpose: newPurpose,
                    frame: capturedFrames[0] || currentVisitorData.frame || null
                 };
                 try {
                    await registerVisitor(newVisitorData);
                 } catch (error) {
                    console.error("Error during addNewVisitForExistingVisitor registration:", error);
                 } finally {
                    hideLoading(button);
                 }
            } else {
                 const cancelMsg = "वापरकर्त्याने नवीन भेट जोडणे रद्द केले.";
                 console.log(cancelMsg);
             }
        }

       async function continueExistingVisit(button) {
            if (!currentVisitorData || !currentVisitorData.visitor || !currentVisitorData.visitor.length) {
                 const alertMsg = "कोणतीही विद्यमान भेट आढळली नाही";
                 alert(alertMsg);
                 return;
             }

            const lastVisit = currentVisitorData.visitor.reduce((latest, current) =>
                (new Date(current.datetime) > new Date(latest.datetime)) ? current : latest
            );

             const confirmMsg = `तुम्हाला खात्री आहे की '${lastVisit.purpose}' या कारणासाठी मागील भेट चालू ठेवायची आहे?`;
             if (confirm(confirmMsg)) {
                 showLoading(button, "भेट सुरू ठेवत आहे...");
                 const newVisitorData = {
                    ...currentVisitorData,
                    purpose: lastVisit.purpose,
                    frame: capturedFrames[0] || currentVisitorData.frame || null
                 };
                 try {
                    await registerVisitor(newVisitorData);
                 } catch (error) {
                    console.error("Error during continueExistingVisit registration:", error);
                 } finally {
                    hideLoading(button);
                 }
             } else {
                 const cancelMsg = "वापरकर्त्याने मागील भेट सुरू ठेवणे रद्द केले.";
                 console.log(cancelMsg);
             }
        }

         async function registerVisitor(visitorData) {
             let finalVisitorData = { ...visitorData };
             const isUpdate = recognizedVisitorData && finalVisitorData.uid && finalVisitorData.uid === recognizedVisitorData.uid;

             if (isUpdate) {
                 finalVisitorData = {
                     ...recognizedVisitorData,
                     purpose: visitorData.purpose,
                     frame: visitorData.frame || recognizedVisitorData.frame || null,
                     visitor: recognizedVisitorData.visitor || []
                 };
             } else if (!finalVisitorData.uid) {
                  finalVisitorData = {
                     ...visitorData,
                     visitor: []
                 };
             }
             finalVisitorData.frame = visitorData.frame || finalVisitorData.frame || null;

             try {
                 const response = await fetch("/register_visitor", {
                     method: "POST",
                     headers: {
                         "Content-Type": "application/json"
                     },
                     body: JSON.stringify(finalVisitorData)
                 });

                 if (!response.ok) {
                     let errorData;
                     try {
                         errorData = await response.json();
                     } catch {
                          throw new Error(`HTTP error! Status: ${response.status}`);
                     }
                     throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                 }

                 const result = await response.json();

                 if (result.success) {
                     const uid = result.uid;
                     let successMsgTemplate = "अभ्यागत यशस्वीरित्या नोंदणीकृत झाला!\n\nअभ्यागत तपशील:\n- भेट आयडी: {visit_id}\n- युनिक वापरकर्ता आयडी: {uid}\n- नाव: {name}\n- कारण: {purpose}";
                     successMsgTemplate = successMsgTemplate
                         .replace('{visit_id}', result.visit_id)
                         .replace('{uid}', uid)
                         .replace('{name}', finalVisitorData.name)
                         .replace('{purpose}', finalVisitorData.purpose);
                     alert(successMsgTemplate);

                     setTimeout(() => {
                         if(finalVisitorData.frame && uid) {
                            processProfileImage(finalVisitorData.frame, uid);
                         }
                     }, 500);

                     const detailsResponse = await fetch(`/get_visitor_details?uid=${uid}`, {
                         cache: "no-store"
                     });

                     if (!detailsResponse.ok) {
                          let errorData;
                         try {
                              errorData = await detailsResponse.json();
                          } catch {
                              throw new Error(`Details fetch failed: ${detailsResponse.status}`);
                          }
                          throw new Error(errorData.message || `Details fetch failed: ${detailsResponse.status}`);
                     }

                     const visitorDetails = await detailsResponse.json();

                     if (visitorDetails.success && visitorDetails.visitor_data) {
                          recognizedVisitorData = visitorDetails.visitor_data;
                         displayExistingVisitorDetails(visitorDetails.visitor_data);
                         if(domElements['registration-form']) domElements['registration-form'].style.display = "none";
                         if(domElements['existing-visitor-form']) domElements['existing-visitor-form'].style.display = "block";
                         if (domElements['new-purpose']) domElements['new-purpose'].value = "";
                         capturedFrames = [];
                         if(domElements['captured-images']) domElements['captured-images'].innerHTML = "";
                         setTimeout(resetForms, 1000);
                     } else {
                          throw new Error(visitorDetails.message || "Failed to fetch updated visitor details.");
                      }
                 } else {
                      throw new Error(result.message || "Registration failed (unknown reason)");
                 }
             } catch (error) {
                 console.error("Registration process error:", error);
                 const errorPrefix = "नोंदणी अयशस्वी: ";
                 alert(`${errorPrefix}${error.message}`);
                 throw error;
             }
         }

        function processProfileImage(imageDataUrl, uid) {
             if (!imageDataUrl || !uid) {
                console.error("Missing image data or UID for profile processing.");
                return;
            }
            fetch(imageDataUrl)
                .then(res => res.blob())
                .then(blob => {
                     if (!blob) {
                        throw new Error("Failed to convert data URL to blob.");
                    }
                    const formData = new FormData();
                    formData.append('image', blob, 'profile.jpg');
                    formData.append('uid', uid);

                    return fetch('/process_profile_image', {
                        method: 'POST',
                        body: formData
                    });
                })
                .then(response => {
                    if (!response.ok) {
                         return response.json().then(errData => {
                              throw new Error(errData.message || `Profile processing failed: ${response.status}`);
                          }).catch(() => {
                              throw new Error(`Profile processing failed: ${response.status}`);
                          });
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.success) {
                        console.log('Profile image processed successfully:', result);
                         if (currentVisitorData && currentVisitorData.uid === uid) {
                              fetch(`/get_visitor_details?uid=${uid}`, { cache: "no-store" })
                                .then(res => res.ok ? res.json() : Promise.reject(`Failed to refetch details: ${res.status}`))
                                .then(details => {
                                    if (details.success && details.visitor_data) {
                                         recognizedVisitorData = details.visitor_data;
                                        displayExistingVisitorDetails(details.visitor_data);
                                    } else {
                                         console.error("Failed to parse refetched details:", details.message);
                                     }
                                }).catch(err => console.error("Error refetching details after profile processing:", err));
                         }
                    } else {
                        console.error('Profile image processing failed on server:', result.message);
                    }
                })
                .catch(error => {
                    console.error('Error in processProfileImage function:', error);
                });
        }

        function resetForms() {
             if(domElements['registration-form']) domElements['registration-form'].style.display = "none";
             if(domElements['existing-visitor-form']) domElements['existing-visitor-form'].style.display = "none";
             if(domElements['recognition-result']) domElements['recognition-result'].textContent = "";
             if(domElements['captured-images']) domElements['captured-images'].innerHTML = "";
             if(domElements['phone-error']) domElements['phone-error'].textContent = "";
              if(domElements['existing-visitor-details']) domElements['existing-visitor-details'].innerHTML = '';
              if(domElements['last-visit-info']) {
                    domElements['last-visit-info'].innerHTML = `<span>मागील भेटी नाहीत</span>`;
               }

            ['name', 'phone', 'email', 'address', 'tahasil', 'purpose', 'new-purpose'].forEach(id => {
                if (domElements[id]) {
                     domElements[id].value = "";
                      if (id === 'tahasil') {
                          domElements[id].selectedIndex = 0;
                      }
                 }
            });

            capturedFrames = [];
            currentVisitorData = null;
            recognizedVisitorData = null;
        }

       function confirmLogout(button) {
            const confirmMsg = "तुम्हाला खात्री आहे की तुम्हाला लॉगआउट करायचे आहे?";
            if (confirm(confirmMsg)) {
                 showLoading(button, "लॉगआऊट करत आहे...");
                 logout().finally(() => hideLoading(button));
            }
        }

       async function logout() {
           try {
               await fetch("/logout");
               localStorage.removeItem("user");
               window.location.href = "/";
           } catch (error) {
                console.error("Logout failed:", error);
                localStorage.removeItem("user");
                window.location.href = "/";
           }
        }
    </script>
</body>
</html>