<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>इनऑफिस एसव्हीएमएस</title>
    <style>
        :root {
            --primary-blue: #2c3e90;
            --secondary-blue: #3498db;
            --light-blue: #e6f2ff;
            --white: #ffffff;
            --text-dark: #2c3e50;
            --text-gray: #94a3b8;
            --new-visitor-green: #10b981;
            --returning-visitor-blue: #3b82f6;
            --complete-red-start: #e74c3c;
            --complete-red-end: #c0392b;
            --action-confirm-start: var(--new-visitor-green);
            --action-confirm-end: #34d399;
            --pending-action-orange-start: #f39c12; /* Added for pending */
            --pending-action-orange-end: #e67e22; /* Added for pending */
            --border-radius: 12px;
            --box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            --box-shadow-hover: 0 12px 30px rgba(0,0,0,0.12);
            --transition: all 0.3s ease;
            --card-hover-transform: translateY(-4px);
            --placeholder-bg: #e2e8f0;
            --placeholder-text: #64748b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-blue);
            color: var(--text-dark);
            line-height: 1.6;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .dashboard-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: var(--light-blue);
        }
        .header {
            background: linear-gradient(100deg, var(--primary-blue), var(--secondary-blue));
            color: var(--white);
            padding: 15px 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header img {height: 60px; width: auto; max-height: 100%; object-fit: contain;}
        .logout-btn {
            background: rgba(255, 255, 255, 0.15);
            color: var(--white);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 22px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: var(--transition);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .main-content {
            flex: 1;
            padding: 20px;
            gap: 15px;
            max-width: 1500px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        .content-section {
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            display: flex;
            flex-direction: column;
            gap: 2px;
            transition: var(--transition);
            position: relative;
        }
        .content-section:hover { box-shadow: var(--box-shadow-hover); }
        .section-title {
            color: var(--primary-blue);
            font-size: 22px;
            font-weight: 600;
            padding-bottom: 1px;
            margin-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
            position: relative;
            text-align: left;
             padding-right: 5px;
        }
        .section-title::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -1px;
            width: 60px;
            height: 3px;
            background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
            border-radius: 3px;
        }
        .positioned-top-right {
             position: absolute;
             top: 15px;
             right: 15px;
             padding: 10px 20px;
             font-size: 14px;
             z-index: 10;
        }
        #current-visitor-section > #completed-meeting-btn {
            margin-top: 20px;
            align-self: center;
            width: auto;
            min-width: 200px;
        }

        .horizontal-scroll-container {
            display: flex;
            overflow-x: auto;
            padding: 10px 0 15px 0;
            gap: 15px;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-blue) var(--light-blue);
            min-height: 200px; /* Adjusted min-height */
            -webkit-overflow-scrolling: touch;
        }
        .horizontal-scroll-container::-webkit-scrollbar { height: 8px; }
        .horizontal-scroll-container::-webkit-scrollbar-track { background: #edf2f7; border-radius: 10px; }
        .horizontal-scroll-container::-webkit-scrollbar-thumb { background-color: var(--secondary-blue); border-radius: 10px; border: 2px solid #edf2f7; }
        .horizontal-scroll-container::-webkit-scrollbar-thumb:hover { background-color: var(--primary-blue); }

        .visitor-card-horizontal {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--light-blue);
            border-radius: var(--border-radius);
            padding: 15px;
            width: 160px;
            flex-shrink: 0;
            text-align: center;
            transition: var(--transition);
            box-shadow: 0 3px 8px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
            gap: 8px;
            position: relative; /* Needed for status badge */
        }
        .visitor-card-horizontal:hover {
            transform: var(--card-hover-transform);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            border-color: var(--secondary-blue);
        }
        .visitor-card-horizontal.selectable-visitor {
            cursor: pointer;
        }
        .visitor-card-horizontal.selectable-visitor:hover {
            border-color: var(--primary-blue);
            background-color: #dbeafe;
        }
        .visitor-card-horizontal .profile-image-container { width: 100px; height: 100px; position: relative; margin-bottom: 5px; }
        .visitor-card-horizontal .profile-image,
        .visitor-card-horizontal .profile-placeholder {
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .visitor-card-horizontal .profile-placeholder {
            background-color: var(--placeholder-bg); color: var(--placeholder-text);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 2.0rem;
        }
        .visitor-card-horizontal strong {
            font-size: 14px; color: var(--primary-blue); font-weight: 600;
            line-height: 1.3; width: 100%; overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            margin-top: 5px; /* Adjust spacing */
        }
        .visitor-card-horizontal .visitor-badge-small {
            padding: 3px 10px; border-radius: 15px; font-size: 0.7rem;
            font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;
            margin-top: auto; /* Pushes badge down if space allows */
        }
        .visitor-badge-small.new-visitor { background-color: var(--new-visitor-green); color: white; }
        .visitor-badge-small.returning-visitor { background-color: var(--returning-visitor-blue); color: white; }

        .visitor-status-badge { /* New badge for pending/completed status on cards */
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: white;
            z-index: 5;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        .visitor-status-badge.pending { background: linear-gradient(100deg, var(--pending-action-orange-start), var(--pending-action-orange-end)); }
        .visitor-status-badge.completed { background: linear-gradient(100deg, var(--complete-red-start), var(--complete-red-end)); }


        .nav-btn {
            background: linear-gradient(100deg, var(--primary-blue), var(--secondary-blue));
            color: var(--white); border: none; padding: 12px 28px; border-radius: 50px;
            cursor: pointer; font-weight: 600; font-size: 15px; letter-spacing: 0.5px;
            transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
        }
        .nav-btn:disabled {
            background: #e2e8f0; color: var(--text-gray); cursor: not-allowed;
            transform: none; box-shadow: none;
        }
        .nav-btn.action-btn {
            background: linear-gradient(100deg, var(--action-confirm-start), var(--action-confirm-end));
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }
         .nav-btn.complete-btn {
            background: linear-gradient(100deg, var(--complete-red-start), var(--complete-red-end));
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
         }
        .nav-btn.action-btn:hover {
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
            transform: translateY(-2px);
        }
         .nav-btn.complete-btn:hover {
             box-shadow: 0 6px 15px rgba(231, 76, 60, 0.4);
             transform: translateY(-2px);
         }
        .visitor-profile {
            width: 100%; background-color: var(--white); border-radius: var(--border-radius);
            padding: 0; display: flex; flex-direction: column; align-items: flex-start;
            position: relative; overflow: hidden;
            border: 1px solid #e2e8f0;
            margin-top: 5px;
        }
        .visitor-header {
            width: 100%; display: flex; align-items: center;
            padding: 25px;
            background: linear-gradient(to right, rgba(44, 62, 144, 0.05), rgba(52, 152, 219, 0.05));
            border-bottom: 1px solid #e2e8f0; gap: 25px;
        }
        .visitor-header .main-profile-image-container {
             width: 180px; height: 180px;
             flex-shrink: 0; position: relative;
        }
        .visitor-header .main-profile-image,
        .visitor-header .main-profile-placeholder {
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
            border: 4px solid var(--white); box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        }
        .visitor-header .main-profile-placeholder {
            background-color: var(--placeholder-bg); color: var(--placeholder-text);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 4rem;
        }
        .profile-dvn-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 2px solid var(--white);
            z-index: 10;
        }
        .visitor-name-type {
            display: flex; flex-direction: column; align-items: flex-start;
            flex-grow: 1; gap: 8px; /* Adjusted gap */
        }
        /* Wrapper for ID and PDF Button */
        .visitor-header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 15px; /* Space between ID and button */
            margin-bottom: 5px; /* Space below this row */
        }
         .visitor-id-header {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-gray);
            margin-bottom: 0; /* Removed bottom margin */
        }
        /* Style for the new PDF button */
        .view-pdf-button {
            background: linear-gradient(100deg, var(--primary-blue), var(--secondary-blue)); /* Keep consistent blue */
            color: var(--white);
            border: none;
            padding: 8px 18px; /* Smaller padding */
            font-size: 13px; /* Smaller font size */
            font-weight: 600;
            border-radius: 50px;
            box-shadow: 0 3px 8px rgba(52, 152, 219, 0.25);
            margin-left: auto; /* Push to the right */
            flex-shrink: 0; /* Prevent shrinking */
            white-space: nowrap; /* Prevent text wrapping */
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex; /* Align icon and text */
            align-items: center;
        }
        .view-pdf-button:hover {
            box-shadow: 0 5px 12px rgba(52, 152, 219, 0.35);
            transform: translateY(-1px);
        }
        .view-pdf-button svg {
            margin-right: 6px;
            fill: currentColor; /* Use button's text color */
        }

        .visitor-header h2 {
            color: var(--primary-blue); font-size: 28px; letter-spacing: 0.5px;
            font-weight: 600; line-height: 1.3;
            margin-bottom: 2px;
        }
        .visitor-phone-header, .visitor-address-header, .visitor-tahasil-header { /* Added address and tahasil classes */
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-dark);
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .visitor-address-header strong, .visitor-tahasil-header strong { /* Style for labels */
            font-weight: 600;
            color: var(--primary-blue);
            margin-right: 5px;
            opacity: 1;
        }
        .visitor-type {
            padding: 6px 18px; border-radius: 50px; font-weight: 600; font-size: 0.8rem;
            display: inline-block; text-transform: uppercase; letter-spacing: 0.5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            margin-top: 5px;
        }
        .visitor-type.new-visitor { background-color: var(--new-visitor-green); color: white; }
        .visitor-type.returning-visitor { background-color: var(--returning-visitor-blue); color: white; }

        .visit-summary {
            width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            padding: 25px; gap: 25px;
        }
        .current-visit-details, .previous-visit-details {
            background-color: #f8fafc; padding: 25px;
            border-radius: var(--border-radius);
            border: 1px solid #e2e8f0;
            transition: var(--transition);
        }
        .current-visit-details:hover, .previous-visit-details:hover {
            transform: var(--card-hover-transform);
            box-shadow: 0 8px 16px rgba(0,0,0,0.06);
            border-color: var(--secondary-blue);
        }
        .current-visit-details h4, .previous-visit-details h4 {
            color: var(--primary-blue); font-size: 18px; position: relative;
            padding-bottom: 10px; margin-bottom: 20px; display: block;
            border-bottom: 1px solid #e2e8f0; font-weight: 600;
        }
         .visit-summary p {
            margin-bottom: 18px; display: flex; flex-direction: column; align-items: flex-start; gap: 6px;
        }
        .visit-summary strong {
            color: var(--text-dark); font-size: 13px; text-transform: uppercase;
            letter-spacing: 0.5px; opacity: 0.7; font-weight: 600;
        }
        .visit-summary .detail-value {
            text-align: left; color: var(--text-dark); width: 100%;
            padding: 12px 15px; background-color: var(--white);
            border-radius: 8px; font-size: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.04);
            border-left: 3px solid var(--secondary-blue);
            line-height: 1.5;
        }

         .additional-actions {
             width: 100%;
             padding: 0 25px 25px 25px;
             display: flex;
             flex-direction: column;
             gap: 20px;
         }

         .form-group {
             display: flex;
             flex-direction: column;
             gap: 5px;
         }

         .form-group label {
             font-weight: 600;
             font-size: 14px;
             color: var(--text-dark);
             opacity: 0.8;
         }

         .form-group textarea,
         .form-group select {
             width: 100%;
             padding: 10px 12px;
             border-radius: 8px;
             border: 1px solid #cbd5e1;
             font-size: 15px;
             background-color: var(--white);
             box-shadow: 0 1px 3px rgba(0,0,0,0.03);
             transition: border-color 0.2s ease;
             color: var(--text-dark);
         }
         .form-group textarea::placeholder {
             color: var(--text-gray);
             opacity: 0.7;
         }
         .form-group select {
             appearance: none;
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3E%3C/svg%3E");
             background-position: right 0.5rem center;
             background-repeat: no-repeat;
             background-size: 1.5em 1.5em;
             padding-right: 2.5rem;
         }
         .form-group textarea:focus,
         .form-group select:focus {
             outline: none;
             border-color: var(--secondary-blue);
             box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
         }
         #save-details-btn {
             margin-top: 10px;
             align-self: center;
             width: auto;
             min-width: 200px;
         }

        .no-visitor-message, .no-items-message {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; padding: 30px 20px; text-align: center; color: var(--text-gray);
            min-height: 120px; font-size: 16px; font-weight: 500;
        }
        /* General Popup Overlay */
        .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center;
            align-items: center; z-index: 1000; visibility: hidden; opacity: 0;
            transition: opacity 0.3s ease, visibility 0s 0.3s linear; backdrop-filter: blur(3px);
        }
        .popup-overlay.active { visibility: visible; opacity: 1; transition: opacity 0.3s ease, visibility 0s linear; backdrop-filter: blur(3px);}
        .popup-content {
            background-color: var(--white); padding: 35px; border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; max-width: 420px; width: 90%;
            transform: translateY(-20px) scale(0.95); transition: transform 0.3s ease, opacity 0.3s ease; opacity: 0;
        }
        .popup-overlay.active .popup-content { transform: translateY(0) scale(1); opacity: 1; }
        .popup-title { color: var(--primary-blue); margin-bottom: 15px; font-size: 22px; font-weight: 600; }
        .popup-content p { margin-bottom: 25px; color: var(--text-dark); opacity: 0.9; }
        .popup-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 15px; }
        .popup-btn { padding: 10px 30px; border-radius: 50px; font-weight: 600; cursor: pointer; transition: var(--transition); font-size: 14px; }
        .popup-btn-confirm { background: linear-gradient(100deg, var(--primary-blue), var(--secondary-blue)); color: var(--white); border: none; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); }
        .popup-btn-cancel { background-color: #e2e8f0; color: var(--text-dark); border: none; }
        .popup-btn:hover { transform: translateY(-2px); }
        .popup-btn-confirm:hover { box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4); }
        .popup-btn-cancel:hover { background-color: #cbd5e1; }
        .popup-btn-confirm.complete-confirm { background: linear-gradient(100deg, var(--complete-red-start), var(--complete-red-end)); box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3); }
        .popup-btn-confirm.complete-confirm:hover { box-shadow: 0 6px 15px rgba(231, 76, 60, 0.4); }
        .popup-btn-confirm.action-confirm { background: linear-gradient(100deg, var(--action-confirm-start), var(--action-confirm-end)); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }
        .popup-btn-confirm.action-confirm:hover { box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4); }

        #action-confirm-summary {
            text-align: left;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 14px;
        }
         #action-confirm-summary p {
             margin-bottom: 8px;
             color: var(--text-dark);
             opacity: 1.0;
             line-height: 1.5;
         }
         #action-confirm-summary strong {
             color: var(--primary-blue);
             margin-right: 5px;
             font-weight: 600;
         }
         #action-confirm-summary span {
             word-break: break-word;
         }

        /* PDF Popup Styles */
        .pdf-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1100; /* Higher than other popups */
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0s 0.3s linear;
        }
        .pdf-popup-overlay.active {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.3s ease, visibility 0s linear;
        }
        .pdf-popup-content {
            position: relative;
            width: 95%;
            height: 95%;
            background-color: #333; /* Dark background for iframe contrast */
            border-radius: 5px;
            overflow: hidden; /* Prevents iframe bleed */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .pdf-close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 24px;
            line-height: 35px;
            text-align: center;
            cursor: pointer;
            z-index: 1101;
            transition: background-color 0.2s ease;
        }
        .pdf-close-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        #pdf-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }


        @media (max-width: 992px) {
             .visit-summary { grid-template-columns: 1fr; }
             .visitor-header { flex-direction: column; align-items: center; text-align: center; }
             .visitor-name-type { align-items: center; }
             .section-title { padding-right: 5px; }
             .visitor-id-header, .visitor-phone-header, .visitor-address-header, .visitor-tahasil-header { text-align: center; }
             .additional-actions { padding: 0 20px 20px 20px; }
             #current-visitor-section > #completed-meeting-btn {
                 min-width: 180px;
                 padding: 11px 24px;
             }
             .horizontal-scroll-container { min-height: 180px; } /* Adjust */
             .visitor-card-horizontal { width: 150px; }
             .visitor-card-horizontal .profile-image-container { width: 90px; height: 90px; }
             .visitor-header-top-row { justify-content: center; } /* Center items when header stacks */
             .view-pdf-button { margin-left: 15px; } /* Add some space when centered */
        }
        @media (max-width: 768px) {
            .header { padding: 12px 20px; }
            .header img {height: 60px; width: auto; max-height: 100%; object-fit: contain;}
            .logout-btn { padding: 7px 18px; font-size: 13px; }
            .main-content { padding: 20px; gap: 20px; }
            .content-section { padding: 10px; }
            .section-title { font-size: 20px; margin-bottom: 10px; }
            .visitor-header { padding: 20px; gap: 20px; }
            .visitor-header .main-profile-image-container { width: 120px; height: 120px; }
            .visitor-header .main-profile-placeholder { font-size: 3.5rem; }
            .profile-dvn-badge { width: 30px; height: 30px; font-size: 12px; top: 3px; right: 3px; border-width: 1px;}
             .visitor-header h2 { font-size: 24px; }
             .visitor-id-header { font-size: 0.85rem; }
             .visitor-phone-header, .visitor-address-header, .visitor-tahasil-header { font-size: 0.95rem; }
            .visit-summary { padding: 20px; gap: 20px; }

            .nav-btn { padding: 11px 24px; font-size: 14px; }
            .visitor-card-horizontal { width: 135px; padding: 12px; gap: 6px;}
            .visitor-card-horizontal .profile-image-container { width: 80px; height: 80px; }
            .visitor-card-horizontal .profile-placeholder { font-size: 1.8rem; }
             .visitor-card-horizontal strong { font-size: 13px; }
            .additional-actions { padding: 0 15px 15px 15px; gap: 15px; }
             #current-visitor-section > #completed-meeting-btn,
             #save-details-btn {
                width: 90%;
                max-width: 300px;
             }
             .horizontal-scroll-container { min-height: 170px; }
             .view-pdf-button {
                padding: 7px 15px;
                font-size: 12px;
                margin-left: 0; /* Reset margin */
                align-self: center; /* Center button below ID */
            }
             .visitor-header-top-row {
                flex-direction: column; /* Stack ID and button */
                align-items: center; /* Align items center */
                gap: 8px;
            }
            .pdf-close-btn {
                width: 30px;
                height: 30px;
                font-size: 20px;
                line-height: 30px;
                top: 3px;
                right: 5px;
            }
        }
        @media (max-width: 480px) {
            .header { padding: 10px 15px; }
            .header h1 { font-size: 19px; }
            .main-content { padding: 15px; gap: 15px; }
            .content-section { padding: 10px; }
            .section-title { font-size: 18px; }
            .visitor-header { padding: 15px; gap: 15px; }
            .visitor-header .main-profile-image-container { width: 100px; height: 100px; }
            .visitor-header .main-profile-placeholder { font-size: 3rem; }
            .profile-dvn-badge { width: 28px; height: 28px; font-size: 11px; top: 2px; right: 2px;}
            .visitor-header h2 { font-size: 21px; }
             .visitor-id-header { font-size: 0.8rem; }
             .visitor-phone-header, .visitor-address-header, .visitor-tahasil-header { font-size: 0.9rem; }
            .visit-summary { padding: 15px; gap: 15px; }
            .current-visit-details, .previous-visit-details { padding: 20px; }
             .visit-summary .detail-value { padding: 10px 12px; font-size: 14px; }

            .nav-btn { width: 100%; justify-content: center; }
             #current-visitor-section > #completed-meeting-btn,
             #save-details-btn {
                 width: 100%;
                 min-width: unset;
                 padding: 10px 20px;
                 font-size: 13px;
             }
            .visitor-card-horizontal { width: 120px; padding: 10px;}
            .visitor-card-horizontal .profile-image-container { width: 70px; height: 70px; }
            .visitor-card-horizontal .profile-placeholder { font-size: 1.6rem; }
            .visitor-card-horizontal strong { font-size: 12px; }
            .additional-actions { padding: 0 10px 10px 10px; gap: 15px; }
            .popup-content { padding: 25px; }
            #action-confirm-summary { padding: 10px; font-size: 13px; }
            .horizontal-scroll-container { min-height: 160px; }
            .visitor-status-badge { font-size: 0.6rem; padding: 2px 6px; top: 5px; right: 5px;}
            .view-pdf-button {
                padding: 6px 12px;
                font-size: 11px;
                width: auto; /* Don't force full width */
                align-self: center;
            }
             .visitor-header-top-row {
                 align-items: center; /* Keep centered */
             }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="header">
          <img src="{{ url_for('static', filename='assets/logo/svmslogo.png') }}" alt="Smart Visitor Management System Logo">
          <button id="logout-btn" class="logout-btn">लॉगआऊट</button>
        </header>

        <div id="logout-popup" class="popup-overlay">
            <div class="popup-content">
                <h3 class="popup-title">लॉगआऊटची पुष्टी करा</h3>
                <p>तुम्हाला खात्री आहे की तुम्हाला लॉगआउट करायचे आहे?</p>
                <div class="popup-buttons">
                    <button id="logout-cancel" class="popup-btn popup-btn-cancel">रद्द करा</button>
                    <button id="logout-confirm" class="popup-btn popup-btn-confirm">लॉगआऊट</button>
                </div>
            </div>
        </div>
         <div id="complete-visit-popup" class="popup-overlay">
            <div class="popup-content">
                <h3 class="popup-title">भेटीच्या समाप्तीची पुष्टी करा</h3>
                <p>तुम्हाला खात्री आहे की ही भेट पूर्ण झाली म्हणून चिन्हांकित करायची आहे?</p>
                <div class="popup-buttons">
                    <button id="complete-visit-cancel" class="popup-btn popup-btn-cancel">रद्द करा</button>
                    <button id="complete-visit-confirm" class="popup-btn popup-btn-confirm complete-confirm">भेट पूर्ण करा</button>
                </div>
            </div>
        </div>
         <div id="action-confirm-popup" class="popup-overlay">
            <div class="popup-content">
                <h3 class="popup-title">अभ्यागत कृतीची पुष्टी करा</h3>
                <div id="action-confirm-summary"></div>
                <p>तुम्हाला खात्री आहे की तुम्हाला हे तपशील कृतीसाठी पाठवायचे आहेत?</p>
                <div class="popup-buttons">
                    <button id="action-cancel-btn" class="popup-btn popup-btn-cancel">रद्द करा</button>
                    <button id="action-confirm-btn" class="popup-btn popup-btn-confirm action-confirm">पुष्टी करा आणि पाठवा</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="content-section">
                <h2 class="section-title">आगामी अभ्यागत</h2>
                <div id="upcoming-visitors-container" class="horizontal-scroll-container">
                    <div class="no-items-message"><p>DVN नियुक्त असलेले आगामी अभ्यागत नाहीत</p></div>
                </div>
            </div>

            <div id="current-visitor-section" class="content-section">
                <h2 class="section-title">सध्याच्या अभ्यागताचा तपशील</h2>
                <div id="current-visitor-details-container">
                    <div class="no-visitor-message"><p>सध्या कोणताही अभ्यागत निवडलेला नाही</p></div>
                </div>
                <button id="completed-meeting-btn" class="nav-btn complete-btn" disabled>अभ्यागताची भेट पूर्ण करा</button>
            </div>

            <div id="action-visitors-section" class="content-section">
                <h2 class="section-title">अभ्यागत कृती प्रोफाइल</h2>
                <div id="action-visitors-container" class="horizontal-scroll-container">
                     <div class="no-items-message"><p>कृती प्रलंबित असलेले अभ्यागत नाहीत</p></div>
                </div>
            </div>

            <div class="content-section">
                <h2 class="section-title">पूर्ण झालेले अभ्यागत</h2>
                <div id="completed-visitors-container" class="horizontal-scroll-container">
                     <div class="no-items-message"><p>पूर्ण झालेले अभ्यागत नाहीत</p></div>
                </div>
            </div>
        </div>
    </div>

     <!-- PDF Viewer Popup -->
     <div id="pdf-popup-overlay" class="pdf-popup-overlay">
         <div class="pdf-popup-content">
             <button id="pdf-close-btn" class="pdf-close-btn">×</button>
             <iframe id="pdf-iframe" src="" frameborder="0"></iframe>
         </div>
     </div>

    <script>
       document.addEventListener('DOMContentLoaded', function() {
            let globalVisitorsList = [];
            let actionVisitorsList = [];
            let completedVisitorsList = [];
            let otherUpcomingVisitors = [];
            let departmentList = [];
            let currentVisitorIndex = -1;
            let currentSelectedVisitId = null;
            let visitorDetailsCache = {};
            const MAX_UPCOMING_VISITORS = 30;
            const MAX_ACTION_VISITORS_DISPLAY = 15;
            const MAX_COMPLETED_VISITORS_DISPLAY = 10;
            const POLLING_INTERVAL = 15000;
            let pollingIntervalId = null;
            let isFetching = false;

            const today = new Date().toISOString().split('T')[0];
            const completedMeetingBtn = document.getElementById('completed-meeting-btn');
            let saveDetailsBtn = null; // Will be assigned after render
            const logoutBtn = document.getElementById('logout-btn');
            const logoutPopup = document.getElementById('logout-popup');
            const logoutCancel = document.getElementById('logout-cancel');
            const logoutConfirm = document.getElementById('logout-confirm');
            const completeVisitPopup = document.getElementById('complete-visit-popup');
            const completeVisitCancel = document.getElementById('complete-visit-cancel');
            const completeVisitConfirm = document.getElementById('complete-visit-confirm');
            const actionConfirmPopup = document.getElementById('action-confirm-popup');
            const actionConfirmSummary = document.getElementById('action-confirm-summary');
            const actionConfirmBtn = document.getElementById('action-confirm-btn'); // Refers to the button inside the action popup
            const actionCancelBtn = document.getElementById('action-cancel-btn');
            const upcomingVisitorsContainer = document.getElementById('upcoming-visitors-container');
            const currentVisitorDetailsContainer = document.getElementById('current-visitor-details-container');
            const actionVisitorsContainer = document.getElementById('action-visitors-container');
            const completedVisitorsContainer = document.getElementById('completed-visitors-container');

            // PDF Popup Elements
            const pdfPopupOverlay = document.getElementById('pdf-popup-overlay');
            const pdfCloseBtn = document.getElementById('pdf-close-btn');
            const pdfIframe = document.getElementById('pdf-iframe');

            let lastTapTime = 0;
            let lastTapTarget = null;
            const doubleTapDelay = 300;

            let currentActionData = null;

            // Event Listeners for fixed elements
            logoutBtn.addEventListener('click', () => logoutPopup.classList.add('active'));
            logoutCancel.addEventListener('click', () => logoutPopup.classList.remove('active'));
            logoutConfirm.addEventListener('click', logout);
            completedMeetingBtn.addEventListener('click', showCompleteVisitPopup);
            completeVisitCancel.addEventListener('click', () => completeVisitPopup.classList.remove('active'));
            completeVisitConfirm.addEventListener('click', executeVisitCompletion);

            actionCancelBtn.addEventListener('click', () => {
                actionConfirmPopup.classList.remove('active');
                if (saveDetailsBtn) { // Check if saveDetailsBtn exists
                    saveDetailsBtn.disabled = false;
                    saveDetailsBtn.textContent = 'संबंधित विभागाला कृतीसाठी पाठवा';
                }
                 // Re-fetch the confirm button inside the popup as it might be replaced
                const currentActionConfirmBtn = document.getElementById('action-confirm-btn');
                if(currentActionConfirmBtn){
                    currentActionConfirmBtn.disabled = false;
                    currentActionConfirmBtn.textContent = 'पुष्टी करा आणि पाठवा';
                }
                currentActionData = null;
                updateButtonStates();
            });
             // PDF Popup Close Listeners (added in initializeApp as well for safety)
             if (pdfCloseBtn) {
                 pdfCloseBtn.addEventListener('click', hidePdfPopup);
             }
             if (pdfPopupOverlay) {
                 pdfPopupOverlay.addEventListener('click', function(event) {
                     if (event.target === pdfPopupOverlay) { hidePdfPopup(); }
                 });
             }

            function logout() {
                if (pollingIntervalId) {
                    clearInterval(pollingIntervalId);
                }
                fetch("/logout")
                    .then(() => { localStorage.removeItem("user"); window.location.href = "/"; })
                    .catch(error => { console.error("Logout failed:", error); localStorage.removeItem("user"); window.location.href = "/"; });
            }

             async function fetchDepartments() {
                 try {
                     const response = await fetch('/departments');
                     if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                     const data = await response.json();
                     departmentList = data.departments || [];
                     console.log("Departments loaded:", departmentList);
                 } catch (error) {
                     console.error('Error fetching departments:', error);
                     departmentList = [];
                 }
             }
             function isValidDvn(dvn) {
                 const dvnString = String(dvn).trim();
                 return dvn != null && dvnString !== '' && !isNaN(parseInt(dvnString, 10));
             }
            async function fetchAndProcessVisitors(isInitialLoad = false) {
                if (isFetching) {
                    console.log("Fetch already in progress. Skipping.");
                    return;
                }
                isFetching = true;
                console.log("Fetching visitor data...");

                try {
                    const response = await fetch('/get_today_visitors');
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const data = await response.json();

                    const allTodayVisits = Object.entries(data.visitors || {})
                        .flatMap(([uid, userData]) =>
                            (userData.visitor || [])
                                .filter(visit => visit.datetime?.startsWith(today))
                                // Make sure document_pdf is included
                                .map(visit => ({ ...visit, uid: uid, name: userData.name, document_pdf: visit.document_pdf }))
                        );

                    let newUpcomingVisitorsWithDvn = [];
                    let newActionVisitors = [];
                    let newCompletedVisitors = [];
                    let newOtherUpcomingVisitors = [];

                    allTodayVisits.forEach(visit => {
                        if (visit.status === 'completed') {
                            newCompletedVisitors.push(visit);
                        } else if (visit.status === 'pending') {
                            newActionVisitors.push(visit);
                        } else {
                            // Keep all non-completed/non-pending in upcoming lists
                            if (isValidDvn(visit.dvn)) {
                                newUpcomingVisitorsWithDvn.push(visit);
                            } else {
                                newOtherUpcomingVisitors.push(visit); // Track those without DVN too if needed later
                            }
                        }
                    });

                    // Sorting
                    newUpcomingVisitorsWithDvn.sort((a, b) => {
                        const numA = parseInt(String(a.dvn).trim(), 10);
                        const numB = parseInt(String(b.dvn).trim(), 10);
                        return numA - numB;
                    });
                    newActionVisitors.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
                    newCompletedVisitors.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));

                    // Check for changes
                    const upcomingChanged = !areArraysEqual(globalVisitorsList, newUpcomingVisitorsWithDvn, 'visit_id');
                    const actionChanged = !areArraysEqual(actionVisitorsList, newActionVisitors, 'visit_id');
                    const completedChanged = !areArraysEqual(completedVisitorsList, newCompletedVisitors, 'visit_id');
                    // const otherUpcomingChanged = !areArraysEqual(otherUpcomingVisitors, newOtherUpcomingVisitors, 'visit_id');

                    // Update lists
                    globalVisitorsList = newUpcomingVisitorsWithDvn;
                    actionVisitorsList = newActionVisitors;
                    completedVisitorsList = newCompletedVisitors;
                    otherUpcomingVisitors = newOtherUpcomingVisitors;

                    let needsCurrentVisitorRender = false;
                    let previousIndex = currentVisitorIndex;
                    let previousSelectedVisitId = currentSelectedVisitId;

                    // Determine if current visitor needs update
                    if (currentSelectedVisitId) {
                        // Find the currently selected visitor *only* in the DVN list
                        currentVisitorIndex = globalVisitorsList.findIndex(v => v.visit_id === currentSelectedVisitId);

                        if (currentVisitorIndex === -1) {
                             // Selected visitor is no longer in the DVN list (maybe completed, actioned, or DVN removed)
                             console.log(`Visitor ${previousSelectedVisitId} no longer in DVN-based upcoming list.`);
                             currentSelectedVisitId = null;
                             // Auto-select the first DVN visitor if available
                             if (globalVisitorsList.length > 0) {
                                 currentVisitorIndex = 0;
                                 currentSelectedVisitId = globalVisitorsList[0].visit_id;
                                 console.log(`Auto-selecting first DVN upcoming visitor: ${currentSelectedVisitId}`);
                             } else {
                                 currentVisitorIndex = -1; // No DVN visitors left
                             }
                             needsCurrentVisitorRender = true; // Force render (either new selection or empty message)
                        } else {
                             // Selected visitor is still in the DVN list
                             // Re-render if the index changed (unlikely here) or if the list content changed
                             if (currentVisitorIndex !== previousIndex || upcomingChanged) {
                                 needsCurrentVisitorRender = true;
                             }
                        }
                    } else {
                        // No visitor was selected previously
                        if (globalVisitorsList.length > 0) {
                            // Auto-select the first DVN visitor
                            currentVisitorIndex = 0;
                            currentSelectedVisitId = globalVisitorsList[0].visit_id;
                            console.log(`Auto-selecting first DVN upcoming visitor: ${currentSelectedVisitId}`);
                            needsCurrentVisitorRender = true;
                        } else {
                            // No DVN visitors available, ensure index is -1
                            currentVisitorIndex = -1;
                            if (previousSelectedVisitId !== null) { // Only re-render if there *was* a selection before
                               needsCurrentVisitorRender = true;
                            }
                        }
                    }

                    // Render sections based on changes
                    if (isInitialLoad || upcomingChanged) {
                        console.log("Rendering Upcoming Visitors (DVN only)");
                        await renderHorizontalVisitors(upcomingVisitorsContainer, globalVisitorsList.slice(0, MAX_UPCOMING_VISITORS), 'DVN नियुक्त असलेले आगामी अभ्यागत नाहीत', true);
                    }
                    if (isInitialLoad || actionChanged) {
                        console.log("Rendering Action Visitors");
                        await renderHorizontalVisitors(actionVisitorsContainer, actionVisitorsList.slice(0, MAX_ACTION_VISITORS_DISPLAY), 'कृती प्रलंबित असलेले अभ्यागत नाहीत', false, 'pending');
                    }
                    if (isInitialLoad || completedChanged) {
                        console.log("Rendering Completed Visitors");
                        await renderHorizontalVisitors(completedVisitorsContainer, completedVisitorsList.slice(0, MAX_COMPLETED_VISITORS_DISPLAY), 'पूर्ण झालेले अभ्यागत नाहीत', false, 'completed');
                    }

                    // Render current visitor section if needed
                    if (isInitialLoad || needsCurrentVisitorRender) {
                         console.log("Rendering Current Visitor");
                         await renderCurrentVisitor(); // This now handles the empty state too
                    } else {
                        // If no render needed, still update button states in case data changed slightly
                         updateButtonStates();
                    }

                } catch (error) {
                    console.error('Error fetching or processing visitors:', error);
                     if (isInitialLoad) {
                         upcomingVisitorsContainer.innerHTML = `<div class="no-items-message"><p>आगामी अभ्यागत लोड करताना त्रुटी.</p></div>`;
                         actionVisitorsContainer.innerHTML = `<div class="no-items-message"><p>कृती अभ्यागत लोड करताना त्रुटी.</p></div>`;
                         currentVisitorDetailsContainer.innerHTML = `<div class="no-visitor-message"><p>डेटा लोड करताना त्रुटी.</p></div>`;
                         completedVisitorsContainer.innerHTML = `<div class="no-items-message"><p>पूर्ण झालेले अभ्यागत लोड करताना त्रुटी.</p></div>`;
                     }
                     updateButtonStates(); // Ensure buttons are disabled on error
                } finally {
                     isFetching = false;
                     console.log("Fetch cycle complete.");
                }
            }
            function areArraysEqual(arr1, arr2, key) {
                if (!arr1 || !arr2) return false;
                if (arr1.length !== arr2.length) return false;
                const ids1 = new Set(arr1.map(item => item[key]));
                for (let i = 0; i < arr2.length; i++) {
                    if (!ids1.has(arr2[i][key])) return false;
                }
                return true;
            }

            async function getVisitorDetails(uid) {
                // Attempt to retrieve from cache first
                 // Cache invalidation might be needed if details can change significantly post-registration
                 // For now, assume basic details (name, phone, address, initial images) don't change often
                if (visitorDetailsCache[uid]) {
                     // Check if the visitor array within the cached data needs update (e.g., new visits added)
                     // This part is tricky without knowing exactly what changes. A simple approach: always fetch if not initial load.
                     // Or, implement a timestamp/version check if possible.
                     // Let's stick to simple caching for now.
                    // console.log(`Using cached details for UID: ${uid}`);
                    return visitorDetailsCache[uid];
                }
                console.log(`Fetching details for UID: ${uid}`);
                try {
                    const response = await fetch(`/get_visitor_details?uid=${uid}`);
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const data = await response.json();
                    if (data.success && data.visitor_data) {
                        visitorDetailsCache[uid] = data.visitor_data; // Store in cache
                        return data.visitor_data;
                    }
                    console.error(`Failed to fetch details for UID: ${uid}`, data.message || 'No visitor_data found');
                    return null; // Indicate failure
                } catch (error) {
                    console.error(`Error fetching details for UID: ${uid}`, error);
                    return null; // Indicate failure
                }
            }
            function getProfileImageHtml(visitorData, visitInfo, cssClassPrefix = 'profile') {
                // Prioritize profile_img, then images array
                let imageUrl = visitorData?.profile_img?.[0] || visitorData?.images?.[0] || null;
                const timestamp = Date.now(); // Cache buster for images
                const finalImageUrl = imageUrl ? `${imageUrl}?t=${timestamp}` : null; // Append timestamp only if URL exists
                const initials = generateInitials(visitorData);
                const altText = visitorData?.name || 'अभ्यागत';
                const placeholderHtml = `<div class="${cssClassPrefix}-placeholder">${initials}</div>`;

                // Image tag with onerror fallback to placeholder
                const imageHtml = finalImageUrl
                    ? `<img src="${finalImageUrl}" alt="${altText}" class="${cssClassPrefix}-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
                    : '';

                 // Determine if DVN badge should be shown (only for main profile and if DVN is valid)
                 const displayDvn = cssClassPrefix === 'main-profile' && visitInfo && isValidDvn(visitInfo.dvn);
                 const dvnBadgeHtml = displayDvn
                     ? `<div class="profile-dvn-badge">${visitInfo.dvn}</div>`
                     : '';

                 // Return the container with image, placeholder (hidden if image loads), and optional DVN badge
                 return `<div class="${cssClassPrefix}-image-container">
                            ${imageHtml}
                            <div class="${cssClassPrefix}-placeholder" ${imageHtml ? 'style="display: none;"' : 'style="display: flex;"'}>${initials}</div>
                            ${dvnBadgeHtml}
                         </div>`;
            }

            function generateInitials(visitorData) {
                 return visitorData?.name?.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() || '?';
            }
            function isReturningVisitorCheck(visitorData) {
                 // Check if the visitor array exists and has more than one entry
                 return visitorData && Array.isArray(visitorData.visitor) && visitorData.visitor.length > 1;
            }
            function updateButtonStates() {
                // Enable/disable 'Complete Meeting' button based on valid selection in DVN list
                const isValidSelection = currentVisitorIndex >= 0 && currentVisitorIndex < globalVisitorsList.length;
                completedMeetingBtn.disabled = !isValidSelection;

                // Find the 'Send for Action' button *if it currently exists in the DOM*
                saveDetailsBtn = document.getElementById('save-details-btn');

                if (saveDetailsBtn) {
                     // Disable if no valid selection OR if it's already submitting
                    saveDetailsBtn.disabled = !isValidSelection || saveDetailsBtn.textContent === 'पाठवत आहे...';
                     // Reset text if it was submitting but selection became invalid
                    if (!isValidSelection && saveDetailsBtn.textContent === 'पाठवत आहे...') {
                         saveDetailsBtn.textContent = 'संबंधित विभागाला कृतीसाठी पाठवा';
                    }
                }

                // Reset 'Complete Meeting' button text if it was submitting but selection became invalid
                if (completedMeetingBtn.textContent === 'पूर्ण होत आहे...') {
                     if (!isValidSelection) {
                        completedMeetingBtn.textContent = 'अभ्यागताची भेट पूर्ण करा';
                     }
                }

                 // Ensure the confirmation button inside the action popup is enabled unless popup is active and submitting
                 const currentActionConfirmBtn = document.getElementById('action-confirm-btn');
                 if (currentActionConfirmBtn && !actionConfirmPopup.classList.contains('active')) {
                     currentActionConfirmBtn.disabled = false;
                     currentActionConfirmBtn.textContent = 'पुष्टी करा आणि पाठवा';
                 }
            }


            async function renderHorizontalVisitors(container, visitorsToShow, emptyMessage, isSelectable = false, status = null) {
                if (!container) {
                    console.error("Container not found for rendering horizontal visitors.");
                    return;
                }
                if (!Array.isArray(visitorsToShow)) {
                    console.error("Invalid data provided for visitorsToShow (expected array):", visitorsToShow);
                     container.innerHTML = `<div class="no-items-message"><p>त्रुटी: अवैध अभ्यागत डेटा.</p></div>`;
                    return;
                }
                if (visitorsToShow.length === 0) {
                    container.innerHTML = `<div class="no-items-message"><p>${emptyMessage}</p></div>`;
                    return;
                }
                // Fetch details for all visitors in parallel
                const detailPromises = visitorsToShow.map(visitInfo => {
                    if (visitInfo && visitInfo.uid) {
                        return getVisitorDetails(visitInfo.uid);
                    }
                    return Promise.resolve(null); // Handle cases with missing uid
                });

                const visitorDetailsArray = await Promise.all(detailPromises);

                // Now create cards using the fetched details
                const cardsHtml = visitorsToShow.map((visitInfo, index) => {
                     if (!visitInfo || !visitInfo.uid) {
                         console.warn("Skipping card render due to missing visitInfo or uid:", visitInfo);
                         return createHorizontalVisitorCard(null, null, false, 'error');
                     }
                     const visitorData = visitorDetailsArray[index]; // Get corresponding fetched detail
                     return createHorizontalVisitorCard(visitInfo, visitorData, isSelectable, visitInfo.status);
                 }).join('');


                 try {
                     // Check if container still exists before updating
                     if (document.body.contains(container)) {
                         container.innerHTML = cardsHtml;
                     } else {
                         console.warn("Container removed before rendering horizontal visitors completed.");
                     }
                 } catch (error) {
                     console.error("Error rendering horizontal visitors:", error);
                     if (document.body.contains(container)) {
                         container.innerHTML = `<div class="no-items-message"><p>अभ्यागत दाखवण्यात त्रुटी.</p></div>`;
                     }
                 }
            }

            function createHorizontalVisitorCard(visitInfo, visitorData, selectable = false, status = null) {
                // Handle error case or missing data
                 if (status === 'error' || !visitorData || !visitInfo) {
                    const errorUid = visitInfo ? ` (UID: ${visitInfo.uid})` : '';
                     return `<div class="visitor-card-horizontal">
                                <div class="profile-image-container"><div class="profile-placeholder">!</div></div>
                                <strong>लोड करताना त्रुटी</strong>
                                <span style="font-size: 0.8em; color: var(--text-gray);">तपशील उपलब्ध नाहीत${errorUid}</span>
                            </div>`;
                }

                const isReturning = isReturningVisitorCheck(visitorData);
                const typeBadgeClass = isReturning ? 'returning-visitor' : 'new-visitor';
                const typeBadgeText = isReturning ? 'परत आलेले' : 'नवीन';
                const profileImageHtml = getProfileImageHtml(visitorData, null, 'profile'); // No DVN badge on small cards
                const displayName = visitorData?.name || visitInfo.name || 'अज्ञात अभ्यागत';
                const selectableClass = selectable ? ' selectable-visitor' : '';
                const dataAttributes = selectable ? `data-uid="${visitInfo.uid}" data-visit-id="${visitInfo.visit_id}"` : '';

                 // Status badge for pending/completed lists
                 const statusMap = { 'pending': 'प्रलंबित', 'completed': 'पूर्ण' };
                 const displayStatus = statusMap[status] || status;

                 let statusBadgeHtml = '';
                 // Only show status badge if status is explicitly pending or completed
                if (status === 'pending' || status === 'completed') {
                    statusBadgeHtml = `<span class="visitor-status-badge ${status}">${displayStatus}</span>`;
                }

                return `
                    <div class="visitor-card-horizontal${selectableClass}" ${dataAttributes}>
                        ${statusBadgeHtml}
                        ${profileImageHtml}
                        <strong>${displayName}</strong>
                        <span class="visitor-badge-small ${typeBadgeClass}">${typeBadgeText}</span>
                    </div>`;
            }

            async function renderCurrentVisitor() {
                 // Remove event listener from the old button if it exists
                 const oldSaveBtn = document.getElementById('save-details-btn');
                 if (oldSaveBtn) {
                     oldSaveBtn.removeEventListener('click', showActionConfirmPopup);
                 }
                 saveDetailsBtn = null; // Reset reference

                 // Check if a valid visitor is selected from the DVN list
                 if (currentVisitorIndex < 0 || currentVisitorIndex >= globalVisitorsList.length) {
                    currentVisitorDetailsContainer.innerHTML = `<div class="no-visitor-message"><p>सध्या कोणताही अभ्यागत निवडलेला नाही</p></div>`;
                    updateButtonStates(); // Ensure buttons are disabled
                    return;
                 }

                const currentVisitInfo = globalVisitorsList[currentVisitorIndex];
                 currentSelectedVisitId = currentVisitInfo.visit_id; // Update the selected ID

                 // Fetch the full details for the selected visitor
                const currentVisitorData = await getVisitorDetails(currentVisitInfo.uid);

                 // Handle case where details couldn't be fetched
                if (!currentVisitorData) {
                    currentVisitorDetailsContainer.innerHTML = `
                        <div class="no-visitor-message">
                            <p>${currentVisitInfo.name || ' निवडलेल्या अभ्यागतासाठी'} तपशील लोड करताना त्रुटी.</p>
                            <p><small>(UID: ${currentVisitInfo.uid}, भेट आयडी: ${currentVisitInfo.visit_id})</small></p>
                        </div>`;
                    updateButtonStates();
                    return;
                }

                const isReturning = isReturningVisitorCheck(currentVisitorData);
                 // Sort all visits for this user by date, descending
                 const allVisits = [...(currentVisitorData.visitor || [])]
                     .sort((a, b) => new Date(b.datetime) - new Date(a.datetime));

                 // Generate profile image HTML (includes DVN badge logic)
                const profileImageHtml = getProfileImageHtml(currentVisitorData, currentVisitInfo, 'main-profile');

                 // --- PDF Button Logic ---
                 const pdfPath = currentVisitInfo.document_pdf;
                 let pdfButtonHtml = '';
                 if (pdfPath && pdfPath.trim() !== '') {
                     const pdfUrl = `/api/get-visitor-document/${currentVisitInfo.visit_id}`;
                     pdfButtonHtml = `
                         <button id="view-pdf-btn" class="view-pdf-button" data-pdf-url="${pdfUrl}">
                            <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" fill="currentColor"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc. --><path d="M0 64C0 28.7 28.7 0 64 0H224V128c0 17.7 14.3 32 32 32H384V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64zm384 64H256V0L384 64z"/></svg>
                             दस्तऐवज पहा
                         </button>
                     `;
                 }
                 // --- End PDF Button Logic ---


                 // Find the most relevant previous visit (completed or pending)
                const previousVisits = allVisits.filter(v => v.visit_id !== currentVisitInfo.visit_id);
                 const actualPreviousVisit = previousVisits.find(v => v.status === 'completed' || v.status === 'pending') || (previousVisits.length > 0 ? previousVisits[0] : null);
                  const statusMap = { 'new': 'नवीन', 'pending': 'प्रलंबित', 'completed': 'पूर्ण', 'unknown': 'अज्ञात' }; // Added 'new' mapping
                  const previousStatusDisplay = statusMap[actualPreviousVisit?.status] || actualPreviousVisit?.status || 'अज्ञात';
                  const currentStatusDisplay = statusMap[currentVisitInfo?.status] || currentVisitInfo?.status || 'अज्ञात'; // Map current status too

                let previousVisitHtml = '';
                if (actualPreviousVisit) {
                    previousVisitHtml = `
                        <div class="previous-visit-details">
                            <h4>मागील भेटीची माहिती</h4>
                            <p><strong>मागील भेटीची तारीख</strong><span class="detail-value">${new Date(actualPreviousVisit.datetime).toLocaleString('mr-IN') || 'N/A'}</span></p>
                            <p><strong>मागील उद्देश</strong><span class="detail-value">${actualPreviousVisit.purpose || 'N/A'}</span></p>
                             <p><strong>मागील स्थिती</strong><span class="detail-value">${previousStatusDisplay}</span></p>
                             ${actualPreviousVisit.forwarding_department ? `<p><strong>मागील फॉरवर्ड विभाग</strong><span class="detail-value">${actualPreviousVisit.forwarding_department}</span></p>` : ''}
                             ${actualPreviousVisit.remark ? `<p><strong>मागील शेरा</strong><span class="detail-value">${actualPreviousVisit.remark}</span></p>` : ''}
                        </div>`;
                } else if (isReturning) { // Is returning but no specific previous visit found in the list (maybe older data)
                     previousVisitHtml = `
                        <div class="previous-visit-details">
                             <h4>मागील भेटीची माहिती</h4>
                             <p>हे परत आलेले अभ्यागत आहेत, परंतु मागील भेटीचे तपशील या लोड केलेल्या डेटामध्ये उपलब्ध नाहीत.</p>
                        </div>`;
                }

                 // Prepare department dropdown options
                 let departmentOptionsHtml = '<option value="">-- विभाग निवडा --</option>';
                 if (departmentList && departmentList.length > 0) {
                     departmentOptionsHtml += departmentList.map(dept =>
                         `<option value="${dept.name}">${dept.name}</option>`
                     ).join('');
                 } else {
                     departmentOptionsHtml += '<option value="" disabled>विभाग लोड होत आहेत...</option>'; // Show loading state
                 }

                 // Construct the main visitor profile HTML
                currentVisitorDetailsContainer.innerHTML = `
                    <div class="visitor-profile">
                        <div class="visitor-header">
                            ${profileImageHtml}
                            <div class="visitor-name-type">
                                 <div class="visitor-header-top-row">
                                     <div class="visitor-id-header">भेट आयडी: ${currentVisitInfo.visit_id || 'N/A'}</div>
                                     ${pdfButtonHtml}
                                 </div>
                                <h2>${currentVisitorData.name || 'अज्ञात अभ्यागत'}</h2>
                                <div class="visitor-phone-header"><strong>फोन:</strong> ${currentVisitorData.phone || 'N/A'}</div>
                                <div class="visitor-address-header"><strong>पत्ता:</strong> ${currentVisitorData.address || 'N/A'}</div>
                                <div class="visitor-tahasil-header"><strong>तहसील:</strong> ${currentVisitorData.tahasil || 'N/A'}</div>
                                <span class="visitor-type ${isReturning ? 'returning-visitor' : 'new-visitor'}">
                                    ${isReturning ? 'परत आलेले अभ्यागत' : 'नवीन अभ्यागत'}
                                </span>
                            </div>
                        </div>
                        <div class="visit-summary">
                            <div class="current-visit-details">
                                <h4>सध्याच्या भेटीचा तपशील</h4>
                                <p><strong>भेटीची वेळ</strong><span class="detail-value">${new Date(currentVisitInfo.datetime).toLocaleString('mr-IN') || 'N/A'}</span></p>
                                <p><strong>भेटीचा उद्देश</strong><span class="detail-value">${currentVisitInfo.purpose || 'N/A'}</span></p>
                                <p><strong>सध्याची स्थिती</strong><span class="detail-value">${currentStatusDisplay}</span></p>
                            </div>
                            ${previousVisitHtml}
                        </div>
                         <div class="additional-actions">
                            <div class="form-group">
                                <label for="remark-input">शेरा (ऐच्छिक)</label>
                                <textarea id="remark-input" name="remark" rows="3" placeholder="काही शेरा लिहा..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="forward-dept-select">यांना फॉरवर्ड करा</label>
                                <select id="forward-dept-select" name="forward_department">
                                     ${departmentOptionsHtml}
                                </select>
                            </div>
                             <button id="save-details-btn" class="nav-btn action-btn">संबंधित विभागाला कृतीसाठी पाठवा</button>
                        </div>
                    </div>`;

                 // Add event listener for the PDF button *after* it's added to the DOM
                 const viewPdfBtn = document.getElementById('view-pdf-btn');
                 if (viewPdfBtn) {
                     viewPdfBtn.addEventListener('click', showPdfPopup);
                 }

                 // Re-assign saveDetailsBtn and add its listener
                 saveDetailsBtn = document.getElementById('save-details-btn');
                 if (saveDetailsBtn) {
                     saveDetailsBtn.addEventListener('click', showActionConfirmPopup);
                 } else {
                     console.error("Failed to find #save-details-btn after render.");
                 }
                 updateButtonStates(); // Update button states based on the new render
            }

             function showCompleteVisitPopup() {
                 if (currentVisitorIndex < 0 || currentVisitorIndex >= globalVisitorsList.length) {
                    console.warn("Attempted to show complete popup with no valid visitor selected.");
                    return;
                 }
                 completeVisitPopup.classList.add('active');
             }


            async function executeVisitCompletion() {
                 if (currentVisitorIndex < 0 || currentVisitorIndex >= globalVisitorsList.length) {
                    console.warn("Complete button clicked with no valid current visitor selected.");
                    updateButtonStates();
                    completeVisitPopup.classList.remove('active');
                    return;
                }

                const currentVisitInfo = globalVisitorsList[currentVisitorIndex];
                // Disable buttons immediately
                completedMeetingBtn.disabled = true;
                completedMeetingBtn.textContent = 'पूर्ण होत आहे...';
                 if (saveDetailsBtn) saveDetailsBtn.disabled = true; // Disable action button too
                completeVisitPopup.classList.remove('active'); // Hide popup

                try {
                    const response = await fetch(`/complete_meeting?visit_id=${currentVisitInfo.visit_id}&uid=${currentVisitInfo.uid}`, { method: 'POST' });
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const data = await response.json();
                    if (!data.success) throw new Error(data.message || 'Failed to mark meeting as completed');

                     console.log(`Visit ${currentVisitInfo.visit_id} marked as completed.`);
                     delete visitorDetailsCache[currentVisitInfo.uid]; // Invalidate cache for this user
                     currentSelectedVisitId = null; // Reset selection
                     currentVisitorIndex = -1;
                     await fetchAndProcessVisitors(); // Refresh all lists

                } catch (error) {
                    console.error('Error completing visit:', error);
                    alert('भेट पूर्ण करताना त्रुटी: ' + error.message);
                     // Re-enable buttons on error, but only if the selection is still valid
                     updateButtonStates();
                } finally {
                    // Ensure button text is reset if it's still in the submitting state
                    if (completedMeetingBtn.textContent === 'पूर्ण होत आहे...') {
                         completedMeetingBtn.textContent = 'अभ्यागताची भेट पूर्ण करा';
                         updateButtonStates(); // Final state update
                    }
                }
            }
             async function showActionConfirmPopup() {
                 if (currentVisitorIndex < 0 || currentVisitorIndex >= globalVisitorsList.length) {
                    console.warn("Action button clicked with no valid current visitor selected.");
                    updateButtonStates();
                    return;
                }
                if (!saveDetailsBtn) { // Check if the button exists
                    console.error("Save button reference is missing.");
                    return;
                }
                 const currentVisitInfo = globalVisitorsList[currentVisitorIndex];
                 const currentVisitorData = await getVisitorDetails(currentVisitInfo.uid); // Fetch details if needed
                 const remarkInput = document.getElementById('remark-input');
                 const forwardDeptSelect = document.getElementById('forward-dept-select');

                 // Ensure elements exist before accessing value
                 const remark = remarkInput ? remarkInput.value.trim() : '';
                 const forwardingDepartment = forwardDeptSelect ? forwardDeptSelect.value : '';
                 const visitorName = currentVisitorData?.name || 'अज्ञात अभ्यागत';

                 if (!forwardingDepartment) {
                     alert('कृपया फॉरवर्ड करण्यासाठी विभाग निवडा.');
                     return;
                 }

                 // Store data needed for submission
                 currentActionData = {
                     visitInfo: currentVisitInfo,
                     remark: remark,
                     forwardingDepartment: forwardingDepartment
                 };

                 // Populate the confirmation popup summary
                 actionConfirmSummary.innerHTML = `
                    <p><strong>अभ्यागत:</strong> <span>${visitorName} (भेट आयडी: ${currentVisitInfo.visit_id})</span></p>
                    <p><strong>यांना फॉरवर्ड करा:</strong> <span>${forwardingDepartment}</span></p>
                    <p><strong>शेरा:</strong> <span>${remark || 'काही नाही'}</span></p>
                 `;

                 // Disable main action buttons
                 saveDetailsBtn.disabled = true;
                 saveDetailsBtn.textContent = 'पाठवत आहे...';
                 completedMeetingBtn.disabled = true;

                 // Ensure popup confirm button is ready
                 const popupConfirmBtn = document.getElementById('action-confirm-btn');
                 if (popupConfirmBtn) {
                     popupConfirmBtn.disabled = false;
                     popupConfirmBtn.textContent = 'पुष्टी करा आणि पाठवा';
                     // Re-attach listener to handle potential DOM replacements
                     const newConfirmBtn = popupConfirmBtn.cloneNode(true);
                     popupConfirmBtn.parentNode.replaceChild(newConfirmBtn, popupConfirmBtn);
                     newConfirmBtn.addEventListener('click', executeActionSubmission);
                 }

                 actionConfirmPopup.classList.add('active'); // Show the popup
            }
             async function executeActionSubmission() {
                 if (!currentActionData) {
                     console.error("No action data available for submission.");
                     actionConfirmPopup.classList.remove('active');
                     updateButtonStates();
                     return;
                 }
                 const { visitInfo, remark, forwardingDepartment } = currentActionData;

                 // Disable popup buttons during submission
                 const localActionConfirmBtn = document.getElementById('action-confirm-btn');
                 const localActionCancelBtn = document.getElementById('action-cancel-btn');
                 if(localActionConfirmBtn) localActionConfirmBtn.disabled = true;
                 if(localActionConfirmBtn) localActionConfirmBtn.textContent = 'पाठवत आहे...';
                 if(localActionCancelBtn) localActionCancelBtn.disabled = true;

                 try {
                     const response = await fetch(`/visitor_action`, {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({
                              visit_id: visitInfo.visit_id,
                              uid: visitInfo.uid,
                              remark: remark,
                              forwarding_department: forwardingDepartment
                          })
                      });

                     // Check for network errors or non-JSON responses first
                      if (!response.ok) {
                          const errorText = await response.text(); // Get error text
                          let errorMessage = `HTTP error! Status: ${response.status}`;
                          try { // Try parsing as JSON for specific error messages
                              const errorData = JSON.parse(errorText);
                              errorMessage = errorData.message || errorData.error || errorMessage;
                          } catch (e) {
                              // If not JSON, use the text content or default HTTP error
                              errorMessage = errorText || errorMessage;
                          }
                          throw new Error(errorMessage);
                      }

                     const data = await response.json(); // Now parse the successful JSON response

                     if (data.success) {
                         console.log(`Action sent for visit ${visitInfo.visit_id}, status should be pending.`);
                         delete visitorDetailsCache[visitInfo.uid]; // Invalidate cache
                         currentSelectedVisitId = null; // Reset selection
                         currentVisitorIndex = -1;
                         actionConfirmPopup.classList.remove('active'); // Close popup
                         await fetchAndProcessVisitors(); // Refresh lists
                     } else {
                         // Handle cases where API returns success: false
                         throw new Error(data.message || 'Failed to send action (API reported failure)');
                     }
                 } catch (error) {
                     console.error('Error sending visitor action:', error);
                     alert('कृती पाठवताना त्रुटी: ' + error.message);
                     actionConfirmPopup.classList.remove('active'); // Close popup on error too
                      // Re-enable popup buttons ONLY if the popup wasn't closed automatically
                     if (actionConfirmPopup.classList.contains('active')) {
                        if(localActionConfirmBtn) localActionConfirmBtn.disabled = false;
                        if(localActionConfirmBtn) localActionConfirmBtn.textContent = 'पुष्टी करा आणि पाठवा';
                        if(localActionCancelBtn) localActionCancelBtn.disabled = false;
                     }
                     updateButtonStates(); // Re-enable main buttons based on current state
                 } finally {
                     // Reset main button state if it was left submitting
                     if (saveDetailsBtn && saveDetailsBtn.textContent === 'पाठवत आहे...') {
                         saveDetailsBtn.textContent = 'संबंधित विभागाला कृतीसाठी पाठवा';
                         updateButtonStates();
                     }
                     currentActionData = null; // Clear action data
                 }
             }

             // Function to handle selecting a visitor from the top scroll list
            function selectVisitor(card) {
                if (!card || !card.classList.contains('selectable-visitor')) return; // Ensure it's a selectable card
                const uid = card.dataset.uid;
                const visitId = card.dataset.visitId;
                if (!uid || !visitId) {
                    console.error("Missing UID or Visit ID on selected card element:", card);
                    return;
                }
                // Find the index *only* within the DVN list (globalVisitorsList)
                const newIndex = globalVisitorsList.findIndex(visitor => visitor.uid === uid && visitor.visit_id === visitId);

                if (newIndex !== -1) {
                     // Check if it's actually a different visitor being selected
                     if(visitId !== currentSelectedVisitId) {
                         console.log(`Selected visitor index: ${newIndex}, visit_id: ${visitId}`);
                         currentVisitorIndex = newIndex;
                         currentSelectedVisitId = visitId;
                         renderCurrentVisitor(); // Render the newly selected visitor
                     } else {
                         console.log(`Visitor ${visitId} already selected.`); // No change needed
                     }
                } else {
                     // This should ideally not happen if only cards from globalVisitorsList are marked selectable
                     console.warn(`Clicked card (UID: ${uid}, VisitID: ${visitId}) is not in the currently selectable upcoming (DVN) list.`);
                     // You might want to check other lists for debugging, but don't select from them
                     const actionIndex = actionVisitorsList.findIndex(visitor => visitor.uid === uid && visitor.visit_id === visitId);
                     const completedIndex = completedVisitorsList.findIndex(visitor => visitor.uid === uid && visitor.visit_id === visitId);
                     if(actionIndex !== -1) console.log("-> Debug: Found in Action Pending list.");
                     if(completedIndex !== -1) console.log("-> Debug: Found in Completed list.");
                }
            }

            // Double-click handler for desktop
            function handleDoubleClickSelection(event) {
                 const card = event.target.closest('.selectable-visitor'); // Find the closest selectable card
                 if (card) {
                    selectVisitor(card); // Pass the card element to the selection function
                 }
            }
            // Double-tap handler for touch devices
            function handleDoubleTapSelection(event) {
                const card = event.target.closest('.selectable-visitor');
                if (!card) return;
                const currentTime = new Date().getTime();
                // Check if the tap is on the same target and within the delay
                if (currentTime - lastTapTime < doubleTapDelay && card === lastTapTarget) {
                    event.preventDefault(); // Prevent zoom or other default actions
                    selectVisitor(card);
                    lastTapTime = 0; // Reset tap time
                    lastTapTarget = null; // Reset target
                } else {
                    // First tap (or tap on a different target)
                    lastTapTime = currentTime;
                    lastTapTarget = card;
                }
            }

            // --- PDF Popup Functions ---
            function showPdfPopup(event) {
                const button = event.currentTarget;
                const pdfUrl = button.dataset.pdfUrl;
                if (pdfUrl && pdfPopupOverlay && pdfIframe) {
                    pdfIframe.src = pdfUrl; // Set iframe source
                    pdfPopupOverlay.classList.add('active'); // Show overlay
                } else {
                    console.error("Could not find PDF URL or popup elements for PDF viewer.");
                    alert("दस्तऐवज लोड करताना त्रुटी.");
                }
            }
            function hidePdfPopup() {
                if (pdfPopupOverlay && pdfIframe) {
                    pdfPopupOverlay.classList.remove('active'); // Hide overlay
                    pdfIframe.src = ''; // Clear src to stop loading/display and free resources
                }
            }
            // --- End PDF Popup Functions ---

            function startPolling() {
                if (pollingIntervalId) {
                    clearInterval(pollingIntervalId); // Clear existing interval if any
                }
                 console.log(`Starting polling with interval: ${POLLING_INTERVAL}ms`);
                 pollingIntervalId = setInterval(() => {
                    // Only poll if not currently fetching and no popups are active
                    if (!isFetching &&
                        !actionConfirmPopup.classList.contains('active') &&
                        !completeVisitPopup.classList.contains('active') &&
                        !logoutPopup.classList.contains('active') &&
                        !pdfPopupOverlay.classList.contains('active')) { // Also check PDF popup
                       fetchAndProcessVisitors(false); // Fetch updates, not initial load
                    } else {
                       console.log("Skipping poll cycle due to active fetch or popup.");
                    }
                 }, POLLING_INTERVAL);
            }

            async function initializeApp() {
                 console.log("Initializing App...");
                 // Initial loading messages
                 upcomingVisitorsContainer.innerHTML = `<div class="no-items-message"><p>लोड होत आहे...</p></div>`;
                 actionVisitorsContainer.innerHTML = `<div class="no-items-message"><p>लोड होत आहे...</p></div>`;
                 currentVisitorDetailsContainer.innerHTML = `<div class="no-visitor-message"><p>लोड होत आहे...</p></div>`;
                 completedVisitorsContainer.innerHTML = `<div class="no-items-message"><p>लोड होत आहे...</p></div>`;

                 // Add essential event listeners for fixed elements (like popup close buttons)
                 if (pdfCloseBtn) {
                     pdfCloseBtn.addEventListener('click', hidePdfPopup);
                 }
                 if (pdfPopupOverlay) {
                    pdfPopupOverlay.addEventListener('click', function(event) {
                        if (event.target === pdfPopupOverlay) { hidePdfPopup(); } // Close on background click
                    });
                 }

                 // Fetch initial data
                 await fetchDepartments();
                 await fetchAndProcessVisitors(true); // Initial fetch and render

                 // Add event listeners for dynamic content containers (visitor selection)
                 upcomingVisitorsContainer.addEventListener('dblclick', handleDoubleClickSelection);
                 upcomingVisitorsContainer.addEventListener('touchend', handleDoubleTapSelection, {passive: false}); // Use passive: false to allow preventDefault

                 // Start polling for updates
                 startPolling();
                 console.log("Initialization complete.");
            }

            // Start the application
            initializeApp();
        });
    </script>
</body>
</html>